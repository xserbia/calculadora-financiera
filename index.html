<!DOCTYPE html>
<html lang="es">
<head>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculadora de Evaluaci√≥n Financiera</title>
<style>
  /* Estilos b√°sicos para el formulario y resultados */
  body {
    font-family: sans-serif;
    margin: 20px;
    padding: 0;
    background-color: #f9f9f9;
  }

  .step, .resultado-categoria {
    display: none;
  }
  .active, .active-res {
    display: block;
  }

  .nav-buttons {
    display: flex;
    justify-content: space-between;
    margin-top: 20px;
  }

  #nav, #navResultados {
    display: flex;
    justify-content: space-around;
    flex-wrap: wrap;
    margin-bottom: 20px;
  }

  #nav div, .nav-res {
    background-color: lightgray;
    border-radius: 5px;
    padding: 10px;
    text-align: center;
    cursor: pointer;
    width: 12%;
    margin: 4px;
  }

  .completed {
    background-color: green;
    color: white;
  }

  .active {
    background-color: yellow;
    color: black;
  }

  .inactive {
    background-color: lightgray;
    color: gray;
  }

  .resultado-categoria {
    border: 1px solid #ccc;
    border-radius: 10px;
    background: white;
    padding: 20px;
  }

  /* Detalles ocultos inicialmente */
  .details {
    visibility: hidden;
    opacity: 0;
    transition: visibility 0s 0.3s, opacity 0.3s ease;
    padding-left: 20px;
    margin-top: 10px;
  }

  .details.show {
    visibility: visible;
    opacity: 1;
    transition: visibility 0s, opacity 0.3s ease;
  }

  .toggle-btn {
    background-color: #007bff;
    color: white;
    padding: 5px 10px;
    border: none;
    cursor: pointer;
  }

  .toggle-btn:hover {
    background-color: #0056b3;
  }

  /* Barra de progreso */
  #progress-bar-container {
    width: 100%;
    background-color: #e0e0e0;
    border-radius: 10px;
    overflow: hidden;
    height: 12px;
    margin-bottom: 20px;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  #progress-bar {
    width: 0%;
    height: 100%;
    background-color: #4caf50;
    transition: width 0.3s ease-in-out;
    border-radius: 10px 0 0 10px;
  }

  /* ‚úÖ Validaci√≥n visual de inputs y selects */
  input:invalid, select:invalid {
    border: 2px solid #dc2626;
    background-color: #ffe4e4;
  }

  input:valid, select:valid {
    border: 2px solid #16a34a;
    background-color: #e7fbe7;
  }

  label {
    font-weight: bold;
    display: block;
    margin-top: 10px;
  }

  /* ‚ùó Estilo para mensajes de error (opcional si agregas <span class="error">) */
  .error {
    color: #dc2626;
    font-size: 0.85rem;
    margin-top: 4px;
    display: block;
  }
</style>
</head>
<body>
<!-- Aqu√≠ estar√° todo el formulario -->
<div id="formularioContainer">
  <form id="calculadoraFormulario">
    <div id="nav">
      <div id="navInfoPersonal" class="inactive" data-target="stepInfoPersonal">Informaci√≥n personal</div>
      <div id="navIngresos" class="inactive" data-target="stepIngresos">Ingresos</div>
      <div id="navGastos" class="inactive" data-target="stepGastos">Gastos</div>
      <div id="navActivos" class="inactive" data-target="stepActivos">Activos</div>
      <div id="navPasivos" class="inactive" data-target="stepPasivos">Pasivos</div>
      <div id="navSeguros" class="inactive" data-target="stepSeguros">Seguros</div>
      <div id="navRetiro" class="inactive" data-target="stepRetiro">Retiro</div>
      <div id="navPatrimonio" class="inactive" data-target="stepPatrimonio">Patrimonio</div>
    </div>
    <!-- Barra de progreso -->
    <div id="progress-bar-container">
      <div id="progress-bar"></div>
    </div>
<!-- Secci√≥n 1: Informaci√≥n personal -->
<div class="step active" id="stepPersonal">
<fieldset>
  <legend><strong>1. Informaci√≥n personal</strong></legend>

  <label for="nombre_completo">Nombre completo</label>
  <input type="text" name="nombre_completo" id="nombre_completo" required><br>

  <label for="ciudad">Ciudad</label>
  <input type="text" name="ciudad" id="ciudad" required><br>

  <label for="zipcode">C√≥digo postal (Zipcode)</label>
  <input type="text" name="zipcode" id="zipcode" pattern="\\d{4,10}" title="Ingrese un c√≥digo postal v√°lido" required><br>

  <label for="pais_residencia">Pa√≠s de residencia</label>
  <select name="pais_residencia" id="pais_residencia" required>
    <option value="">Selecciona un pa√≠s</option>
    <option value="Estados Unidos">Estados Unidos</option>
    <option value="M√©xico">M√©xico</option>
    <option value="Argentina">Argentina</option>
    <option value="Colombia">Colombia</option>
    <option value="Chile">Chile</option>
    <option value="Espa√±a">Espa√±a</option>
    <option value="Per√∫">Per√∫</option>
    <option value="Venezuela">Venezuela</option>
    <option value="Ecuador">Ecuador</option>
    <option value="Guatemala">Guatemala</option>
    <option value="Honduras">Honduras</option>
    <option value="El Salvador">El Salvador</option>
    <option value="Costa Rica">Costa Rica</option>
    <option value="Panam√°">Panam√°</option>
    <option value="Uruguay">Uruguay</option>
    <option value="Paraguay">Paraguay</option>
    <option value="Rep√∫blica Dominicana">Rep√∫blica Dominicana</option>
    <option value="Bolivia">Bolivia</option>
    <option value="Cuba">Cuba</option>
    <option value="Nicaragua">Nicaragua</option>
    <option value="Canad√°">Canad√°</option>
    <option value="Brasil">Brasil</option>
    <option value="Otro">Otro</option>
  </select><br>

  <label for="estado_civil">Estado civil</label>
  <select name="estado_civil" id="estado_civil" required>
    <option value="">Selecciona una opci√≥n</option>
    <option value="soltero">Soltero(a)</option>
    <option value="casado">Casado(a)</option>
    <option value="union_libre">Uni√≥n libre</option>
    <option value="divorciado">Divorciado(a)</option>
    <option value="viudo">Viudo(a)</option>
  </select><br>

  <label for="numero_dependientes">N√∫mero de dependientes</label>
  <input type="number" name="numero_dependientes" id="numero_dependientes" min="0" required><br>

  <label for="email">Correo electr√≥nico</label>
  <input type="email" name="email" id="email" required><br>
</fieldset>
  <div class="nav-buttons">
    <button type="button" onclick="nextStep('stepIngresos')">Siguiente</button>
  </div>
</div>

<!-- Secci√≥n 2: Ingresos y Ahorros (Anual) -->
<div class="step" id="stepIngresos">
  <fieldset>
    <legend><strong>2. Ingresos y ahorros (Anual)</strong></legend>
    <label>Salario<br><input type="number" name="salario"></label><br><br>
    <label>Ingreso por negocio<br><input type="number" name="ingreso_negocio"></label><br><br>
    <label>Bonos<br><input type="number" name="bonos"></label><br><br>
    <label>Dividendos e intereses<br><input type="number" name="dividendos_intereses"></label><br><br>
    <label>Renta<br><input type="number" name="renta"></label><br><br>
    <label>Otros ingresos<br><input type="number" name="otros_ingresos"></label><br><br>
    
    <h4>Ahorros:</h4>
    <label>Aporte anual personal al retiro<br><input type="number" name="aporte_personal_retiro"></label><br><br>
    <label>Aporte anual del empleador al retiro<br><input type="number" name="aporte_empleador_retiro"></label><br><br>
    <label>Otros ahorros<br><input type="number" name="otros_ahorros"></label><br><br>
  </fieldset>
  <div class="nav-buttons">
    <button type="button" onclick="guardarDatosYAvanzar('stepGastos')">Siguiente</button>
    <button type="button" onclick="nextStep('stepGastos')">Siguiente</button>
  </div>
</div>

<!-- Secci√≥n 3: Gastos -->
<div class="step" id="stepGastos">
  <fieldset>
    <legend><strong>3. Gastos</strong></legend>
    <!-- Secci√≥n de Pago de Deuda -->
    <div>
      <button onclick="toggleDeudaDetails()">Abrir/Cerrar Pago de Deuda</button>
      <div id="deudaDetails" style="display:none; padding-left: 20px;">
        <label>Hipoteca (o renta)<br><input type="number" name="hipoteca"></label><br><br>
        <label>Pr√©stamo de auto<br><input type="number" name="prestamo_auto"></label><br><br>
        <label>Pr√©stamo educativo<br><input type="number" name="prestamo_educativo"></label><br><br>
        <label>Pr√©stamo personal<br><input type="number" name="prestamo_personal"></label><br><br>
        <label>L√≠nea de cr√©dito<br><input type="number" name="linea_credito"></label><br><br>
        <label>Manutenci√≥n<br><input type="number" name="manutencion"></label><br><br>
        <label>Tarjetas de cr√©dito<br><input type="number" name="tarjetas_credito"></label><br><br>
        <label>Otros<br><input type="number" name="otros_deuda"></label><br><br>
      </div>
    </div>

    <!-- Secci√≥n de Gastos Diarios -->
    <div>
      <button onclick="toggleGastosDetails()">Abrir/Cerrar Gastos Diarios</button>
      <div id="gastosDetails" style="display:none; padding-left: 20px;">
        <label>Servicio p√∫blico<br><input type="number" name="servicio_publico"></label><br><br>
        <label>Cuidado de hijos<br><input type="number" name="cuidado_hijos"></label><br><br>
        <label>Mantenimiento auto<br><input type="number" name="mantenimiento_auto"></label><br><br>
        <label>Cuidado personal<br><input type="number" name="cuidado_personal"></label><br><br>
        <label>Supermercado<br><input type="number" name="supermercado"></label><br><br>
        <label>Comidas afuera<br><input type="number" name="comidas_afuera"></label><br><br>
        <label>Ropa<br><input type="number" name="ropa"></label><br><br>
        <label>Vacaciones<br><input type="number" name="vacaciones"></label><br><br>
        <label>Muebles y enseres<br><input type="number" name="muebles_enseres"></label><br><br>
        <label>Gastos M√©dicos y dentista<br><input type="number" name="gastos_medicos"></label><br><br>
        <label>Telecomunicaciones<br><input type="number" name="telecomunicaciones"></label><br><br>
        <label>Mantenimiento del hogar<br><input type="number" name="mantenimiento_hogar"></label><br><br>
        <label>Entretenimiento<br><input type="number" name="entretenimiento"></label><br><br>
        <label>Libros y membres√≠a de contenido<br><input type="number" name="libros_membresia"></label><br><br>
        <label>Regalos y mesada<br><input type="number" name="regalos_mesada"></label><br><br>
        <label>Donaciones<br><input type="number" name="donaciones"></label><br><br>
        <label>Fiestas<br><input type="number" name="fiestas"></label><br><br>
        <label>Mejoras al hogar<br><input type="number" name="mejoras_hogar"></label><br><br>
        <label>Dues<br><input type="number" name="dues"></label><br><br>
        <label>Servicios profesionales<br><input type="number" name="servicios_profesionales"></label><br><br>
        <label>Gastos de mascota<br><input type="number" name="gastos_mascota"></label><br><br>
        <label>Otros<br><input type="number" name="otros_gastos_diarios"></label><br><br>
      </div>
    </div>
    
    <!-- Secci√≥n de Impuestos -->
    <div>
      <button onclick="toggleImpuestosDetails()">Abrir/Cerrar Impuestos</button>
      <div id="impuestosDetails" style="display:none; padding-left: 20px;">
        <label>Federal<br><input type="number" name="impuesto_federal"></label><br><br>
        <label>Seguro Social<br><input type="number" name="seguro_social"></label><br><br>
        <label>Medicare<br><input type="number" name="medicare"></label><br><br>
        <label>Estatales y locales<br><input type="number" name="impuesto_estatal_local"></label><br><br>
        <label>Propiedad<br><input type="number" name="impuesto_propiedad"></label><br><br>
        <label>Auto<br><input type="number" name="impuesto_auto"></label><br><br>
      </div>
    </div>
  <div class="nav-buttons">
    <button type="button" onclick="prevStep('stepIngresos')">Anterior</button>
    <button type="button" onclick="nextStep('stepActivos')">Siguiente</button>
  </div>
      </fieldset>
    </div>

    <!-- Secci√≥n 4: Activos -->
    <div class="step" id="stepActivos">
      <fieldset>
        <legend><strong>4. Activos</strong></legend>
        <label>Cuentas bancarias y de ahorro<br><input type="number" name="cuentas_bancarias"></label><br><br>
        <label>Inversiones (no retiro)<br><input type="number" name="cuentas_inversion"></label><br><br>
        <label>Cuentas de retiro<br><input type="number" name="cuentas_retiro"></label><br><br>
        <label>Valor de la vivienda principal<br><input type="number" name="valor_vivienda"></label><br><br>
        <label>Propiedades de alquiler<br><input type="number" name="valor_propiedades_alquiler"></label><br><br>
        <label>Otras propiedades (vacacionales, etc.)<br><input type="number" name="valor_otros_activos"></label><br><br>
        <label>Veh√≠culos<br><input type="number" name="valor_vehiculos"></label><br><br>
        <label>Otros activos (joyas, muebles, etc.)<br><input type="number" name="valor_otros"></label><br><br>
      </fieldset>
<div class="nav-buttons">
  <button type="button" onclick="guardarDatosYAvanzar('stepPasivos')">Siguiente</button>
  <button type="button" onclick="nextStep('stepPasivos')">Siguiente</button>
</div>
    </div>

    <!-- Secci√≥n 5: Pasivos -->
    <div class="step" id="stepPasivos">
      <fieldset>
        <legend><strong>5. Pasivos</strong></legend>
        <label>Deuda de tarjetas de cr√©dito<br><input type="number" name="deuda_tarjetas"></label><br><br>
        <label>Hipotecas o alquiler<br><input type="number" name="deuda_hipotecaria"></label><br><br>
        <label>Deuda comercial<br><input type="number" name="deuda_comercial"></label><br><br>
        <label>Pr√©stamos para veh√≠culos<br><input type="number" name="deuda_vehiculos"></label><br><br>
        <label>Deuda estudiantil<br><input type="number" name="deuda_estudios"></label><br><br>
        <label>Otras deudas<br><input type="number" name="deuda_otros"></label><br><br>
      </fieldset>
<div class="nav-buttons">
  <button type="button" onclick="prevStep('stepActivos')">Anterior</button>
  <button type="button" onclick="nextStep('stepSeguros')">Siguiente</button>
</div>
    </div>
    
<!-- Secci√≥n 6: Seguros -->
<div class="step" id="stepSeguros">
  <fieldset>
    <legend><strong>6. Seguros</strong></legend>
    <p>Selecciona los seguros que tienes y su costo anual:</p>

    <label>
      <input type="checkbox" name="tiene_seguro_vida"> Seguro de vida
      <input type="number" name="seguro_vida" placeholder="Costo anual ($)" step="0.01">
    </label><br>

    <label>
      <input type="checkbox" name="tiene_seguro_salud"> Seguro de salud
      <input type="number" name="seguro_medico" placeholder="Costo anual ($)" step="0.01">
    </label><br>

    <label>
      <input type="checkbox" name="tiene_seguro_incapacidad"> Seguro de incapacidad
      <input type="number" name="seguro_incapacidad" placeholder="Costo anual ($)" step="0.01">
    </label><br>

    <label>
      <input type="checkbox" name="tiene_seguro_ltc"> Seguro de cuidado a largo plazo (LTC)
      <input type="number" name="seguro_ltc" placeholder="Costo anual ($)" step="0.01">
    </label><br>

    <label>
      <input type="checkbox" name="tiene_seguro_hogar"> Seguro del hogar
      <input type="number" name="seguro_propiedad" placeholder="Costo anual ($)" step="0.01">
    </label><br>

    <label>
      <input type="checkbox" name="tiene_seguro_auto"> Seguro de auto
      <input type="number" name="seguro_auto" placeholder="Costo anual ($)" step="0.01">
    </label><br>

    <label>
      <input type="checkbox" name="tiene_seguro_umbrella"> Seguro umbrella
      <input type="number" name="seguro_umbrella" placeholder="Costo anual ($)" step="0.01">
    </label><br><br>

    <label>
  <input type="checkbox" name="tiene_seguro_renta"> Seguro de renta
  <input type="number" name="seguro_renta" placeholder="Costo anual ($)" step="0.01">
</label><br>

<label>
  <input type="checkbox" name="tiene_seguro_propiedad_personal"> Seguro de propiedad personal
  <input type="number" name="seguro_propiedad_personal" placeholder="Costo anual ($)" step="0.01">
</label><br>

    <label>
      <input type="checkbox" id="ningunSeguroActivo" name="ningunSeguroActivo">
      No tengo seguros actualmente
    </label>
  </fieldset>

  <div class="nav-buttons">
    <button type="button" onclick="prevStep('stepPasivos')">Anterior</button>
    <button type="button" onclick="nextStep('stepRetiro')">Siguiente</button>
  </div>
</div>
<!-- Secci√≥n 7: Retiro -->
<div class="step" id="stepRetiro">
  <fieldset>
    <legend><strong>8. Informaci√≥n de retiro</strong></legend>

    <!-- Mostrar datos ya capturados -->
    <label>Salario anual considerado<br><input type="number" id="salario_mostrado" name="salario_mostrado" readonly></label><br>
    <label>Ahorro acumulado para retiro<br><input type="number" id="ahorro_retiro_mostrado" name="ahorro_retiro_mostrado" readonly></label><br>
    <label>Aporte anual personal<br><input type="number" id="aporte_personal_mostrado" name="aporte_personal_mostrado" readonly></label><br>
    <label>Aporte anual empleador<br><input type="number" id="aporte_empleador_mostrado" name="aporte_empleador_mostrado" readonly></label><br>

    <hr>

    <!-- Inputs que debe llenar el usuario, respetando tus nombres -->
    <label>Edad actual<br><input type="number" name="edad" id="edad"></label><br>
    <label>Edad deseada de retiro<br><input type="number" name="edad_retiro" id="edad_retiro"></label><br>
    <label>Expectativa de vida<br><input type="number" name="expectativa_vida" id="expectativa_vida" value="100"></label><br>
    <label>Porcentaje de reemplazo deseado (%)<br><input type="number" name="porcentaje_reemplazo" id="porcentaje_reemplazo" value="70"></label><br>
    <label>Ingreso por pensi√≥n o seguro social (anual)<br><input type="number" name="ingreso_seguro_social" id="ingreso_seguro_social"></label><br>
    <label>Tasa de acumulaci√≥n estimada (%)<br><input type="number" name="tasa_acumulacion" id="tasa_acumulacion" step="0.01"></label><br>
    <label>Tasa estimada durante retiro (%)<br><input type="number" name="tasa_retiro" id="tasa_retiro" step="0.01"></label><br>
    <label>Inflaci√≥n estimada (%)<br><input type="number" name="inflacion_esperada" id="inflacion_esperada" step="0.01"></label><br>

  </fieldset>

  <div class="nav-buttons">
    <button type="button" onclick="prevStep('stepSeguros')">Anterior</button>
    <button type="button" onclick="nextStep('stepPatrimonio')">Siguiente</button>
  </div>
</div>

    <!-- Secci√≥n 8: Patrimonio -->
    <div class="step" id="stepPatrimonio">
      <fieldset>
        <legend><strong>7. Patrimonio</strong></legend>
        <label>Documentos disponibles:<br>
          <input type="checkbox" name="trust"> Trust<br>
          <input type="checkbox" name="will"> Testamento<br>
          <input type="checkbox" name="advance_medical_directive"> Directiva m√©dica anticipada<br>
          <input type="checkbox" name="power_of_attorney"> Poder legal<br>
          <input type="checkbox" name="beneficiary_designation"> Designaci√≥n de beneficiarios<br>
          <input type="checkbox" name="property_deeds"> T√≠tulos de propiedad<br>
        </label><br>
        <label>
          <input type="checkbox" id="ningunPatrimonioActivo" name="ningunPatrimonioActivo">
          No tengo documentos patrimoniales actualmente
        </label>
      </fieldset>
      <div class="nav-buttons">
      <button type="button" onclick="prevStep('stepRetiro')">Anterior</button>
      <button type="button" onclick="procesarResultados()">Calcular</button>
    </div>
    </div>
  </form>
</div>
  <!-- SECCI√ìN DE RESULTADOS -->
<div id="resultadosContainer" style="display:none;">
  <h2>Resultados de tu evaluaci√≥n financiera</h2>
  <div id="navResultados">
    <div class="nav-res inactive" onclick="mostrarResultado('resA')">A. Flujo</div>
    <div class="nav-res inactive" onclick="mostrarResultado('resB')">B. Deuda</div>
    <div class="nav-res inactive" onclick="mostrarResultado('resC')">C. Patrimonio</div>
    <div class="nav-res inactive" onclick="mostrarResultado('resD')">D. Seguridad</div>
    <div class="nav-res inactive" onclick="mostrarResultado('resE')">E. Riesgo</div>
    <div class="nav-res inactive" onclick="mostrarResultado('resF')">F. Patrimonial</div>
    <div class="nav-res inactive" onclick="mostrarResultado('resG')">G. Retiro</div>
    <div class="nav-res inactive" onclick="mostrarResultado('resH')">H. Estr√©s</div>
  </div>

  <h3>Distribuci√≥n de gastos</h3>
  <canvas id="graficoGastos" width="100" height="100"></canvas>

  <div id="resA" class="resultado-categoria active-res">[Resultados A]</div>
  <div id="resB" class="resultado-categoria">[Resultados B]</div>
  <div id="resC" class="resultado-categoria">[Resultados C]</div>
  <div id="resD" class="resultado-categoria">[Resultados D]</div>
  <div id="resE" class="resultado-categoria">[Resultados E]</div>
  <div id="resF" class="resultado-categoria">[Resultados F]</div>
  <div id="resG" class="resultado-categoria">[Resultados G]</div>
  <div id="resH" class="resultado-categoria">[Resultados H]</div>
</div>
<script>
  // ‚úÖ Variable global para almacenar los datos del formulario
  let data = {};

  // ‚úÖ Funci√≥n para mostrar resultados por secci√≥n
  function mostrarResultado(id) {
    const canvas = document.getElementById('graficoGastos');
    if (!canvas) {
      console.error("El canvas para el gr√°fico de dona no se encuentra.");
      return;
    }

    if (id !== 'resA') {
      canvas.style.display = 'none';
    } else {
      canvas.style.display = 'block';
      mostrarGraficoGastos(data);
    }

    document.querySelectorAll('.resultado-categoria').forEach(div => div.classList.remove('active-res'));
    document.getElementById(id).classList.add('active-res');
    document.querySelectorAll('#navResultados .nav-res').forEach(nav => nav.classList.remove('active'));
    const current = Array.from(document.querySelectorAll('#navResultados .nav-res')).find(nav => nav.textContent.includes(id.replace('res', '')));
    if (current) current.classList.add('active');
  }

  // ‚úÖ Funci√≥n para mostrar gr√°fico de dona
  function mostrarGraficoGastos(data) {
    const canvas = document.getElementById('graficoGastos');
    if (!canvas) {
      console.error("El canvas para el gr√°fico de dona no se encuentra.");
      return;
    }

    const ctx = canvas.getContext('2d');
    if (window.myChart) window.myChart.destroy();

    const gastosData = {
      labels: ['Pago de deuda', 'Gastos diarios', 'Seguros', 'Impuestos', 'Ahorro personal'],
      datasets: [{
        label: 'Distribuci√≥n de gastos',
        data: [
          (parseFloat(data.hipoteca) || 0) +
          (parseFloat(data.prestamo_auto) || 0) +
          (parseFloat(data.prestamo_educativo) || 0) +
          (parseFloat(data.prestamo_personal) || 0) +
          (parseFloat(data.linea_credito) || 0) +
          (parseFloat(data.manutencion) || 0) +
          (parseFloat(data.tarjetas_credito) || 0) +
          (parseFloat(data.otros_deuda) || 0) +
          (parseFloat(data.deuda_vehiculos) || 0),

          (parseFloat(data.servicio_publico) || 0) +
          (parseFloat(data.cuidado_hijos) || 0) +
          (parseFloat(data.mantenimiento_auto) || 0) +
          (parseFloat(data.cuidado_personal) || 0) +
          (parseFloat(data.supermercado) || 0) +
          (parseFloat(data.comidas_afuera) || 0) +
          (parseFloat(data.ropa) || 0) +
          (parseFloat(data.vacaciones) || 0) +
          (parseFloat(data.muebles_enseres) || 0) +
          (parseFloat(data.gastos_medicos) || 0) +
          (parseFloat(data.telecomunicaciones) || 0) +
          (parseFloat(data.mantenimiento_hogar) || 0) +
          (parseFloat(data.entretenimiento) || 0) +
          (parseFloat(data.libros_membresia) || 0) +
          (parseFloat(data.regalos_mesada) || 0) +
          (parseFloat(data.donaciones) || 0) +
          (parseFloat(data.fiestas) || 0) +
          (parseFloat(data.mejoras_hogar) || 0) +
          (parseFloat(data.dues) || 0) +
          (parseFloat(data.servicios_profesionales) || 0) +
          (parseFloat(data.gastos_mascota) || 0) +
          (parseFloat(data.otros_gastos_diarios) || 0),

          (parseFloat(data.seguro_vida) || 0) +
          (parseFloat(data.seguro_medico) || 0) +
          (parseFloat(data.seguro_propiedad) || 0) +
          (parseFloat(data.seguro_renta) || 0) +
          (parseFloat(data.seguro_umbrella) || 0) +
          (parseFloat(data.seguro_incapacidad) || 0) +
          (parseFloat(data.seguro_auto) || 0) +
          (parseFloat(data.seguro_propiedad_personal) || 0),

          (parseFloat(data.impuesto_federal) || 0) +
          (parseFloat(data.impuesto_estatal_local) || 0) +
          (parseFloat(data.impuesto_propiedad) || 0) +
          (parseFloat(data.impuesto_auto) || 0) +
          (parseFloat(data.seguro_social) || 0) +
          (parseFloat(data.medicare) || 0),

          (parseFloat(data.aporte_personal_retiro) || 0) + (parseFloat(data.otros_ahorros) || 0)
        ],
        backgroundColor: ['#FF5733', '#33FF57', '#3357FF', '#FF33A1', '#FFC300'],
        hoverOffset: 4
      }]
    };

  const config = {
    type: 'doughnut',
    data: gastosData,
options: {
  responsive: true,
  plugins: {
    legend: { position: 'top' },
    tooltip: {
      callbacks: {
        label: function(context) {
          const data = context.chart.data.datasets[0].data;
          const total = data.reduce((acc, val) => acc + val, 0);
          const value = context.raw;
          const percent = total ? ((value / total) * 100).toFixed(1) : 0;
          return `${context.label}: ${percent}%`;
              }
            }
          }
        }
      }
    };

    window.myChart = new Chart(ctx, config);
  }

  // ‚úÖ Funci√≥n placeholder para calcular y mostrar los resultados
  function calcularResultados(data) {
    document.getElementById("resA").innerHTML = `
      Ingreso mensual neto: $${(data.ingreso_neto / 12 || 0).toFixed(2)}<br>
      Ahorro personal anual: $${(data.aporte_personal_retiro || 0).toFixed(2)}
    `;
    // Puedes continuar agregando m√°s resultados aqu√≠ para resB, resC, etc.
  }

  // ‚úÖ Funci√≥n para actualizar la barra de progreso
function updateProgressBar(stepName, totalSteps) {
  const steps = Array.from(document.querySelectorAll('.step'));
  const currentIndex = steps.findIndex(step => step.id === stepName) + 1;
  const progress = (currentIndex / totalSteps) * 100;
  document.getElementById('progress-bar').style.width = progress + '%';
}

  // ‚úÖ Funciones para avanzar y retroceder entre pasos
function nextStep(stepName) {
  const steps = document.querySelectorAll('.step');
  steps.forEach(stepDiv => stepDiv.classList.remove('active'));

  const stepToShow = document.getElementById(stepName);
  if (stepToShow) {
    stepToShow.classList.add('active');
    updateNav(stepName);
    updateProgressBar(stepName, steps.length);

    // üîµ ACTUALIZA data SIEMPRE al moverse de step
    data = obtenerDatosFormulario();
    console.log("üì¶ Data actualizada en nextStep:", data); // <<<<<<<<

    if (stepName === 'stepRetiro') {
      console.log("‚û°Ô∏è Llegando a stepRetiro");
      llenarCamposRetiro(data);
    }
  } else {
    console.error("Secci√≥n no encontrada: " + stepName);
  }
}
  function prevStep(stepName) {
    nextStep(stepName);
  }

  // ‚úÖ Actualizar navegaci√≥n visual
  function updateNav(step) {
    const navItems = document.querySelectorAll('#nav div');
    navItems.forEach((item, index) => {
      item.classList.remove('completed', 'active', 'inactive');
      if (index < step - 1) item.classList.add('completed');
      else if (index === step - 1) item.classList.add('active');
      else item.classList.add('inactive');
    });
  }

  // ‚úÖ Permitir navegaci√≥n directa desde la barra
  document.querySelectorAll('#nav div').forEach((navItem, index) => {
    navItem.addEventListener('click', function () {
      document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
      document.querySelectorAll('.step')[index].classList.add('active');
      updateNav(index + 1);
    });
  });

  // ‚úÖ Funciones para mostrar/ocultar detalles
  function toggleDeudaDetails() {
    const el = document.getElementById("deudaDetails");
    el.style.display = el.style.display === "none" ? "block" : "none";
  }

  function toggleGastosDetails() {
    const el = document.getElementById("gastosDetails");
    el.style.display = el.style.display === "none" ? "block" : "none";
  }

  function toggleSegurosDetails() {
    const el = document.getElementById("segurosDetails");
    el.style.display = el.style.display === "none" ? "block" : "none";
  }

  function toggleImpuestosDetails() {
    const el = document.getElementById("impuestosDetails");
    el.style.display = el.style.display === "none" ? "block" : "none";
  }
  function calcularResultados(data) {
    calcularCategoriaA(data);
    calcularCategoriaB(data);
    calcularCategoriaC(data);
    calcularCategoriaD(data);
    calcularCategoriaE(data);
    calcularCategoriaF(data);
    calcularCategoriaG(data);
    calcularCategoriaH(data);
  }
// Funci√≥n para mostrar los resultados (solo se muestra la dona en la secci√≥n de flujo)
function mostrarResultado(id) {
  // Primero, eliminamos el gr√°fico de dona de todas las secciones
  const canvas = document.getElementById('graficoGastos');
  if (!canvas) {
    console.error("El canvas para el gr√°fico de dona no se encuentra.");
    return;
  }

  if (id !== 'resA') {
    canvas.style.display = 'none'; // Ocultamos el gr√°fico en otras secciones
  } else {
    // Si estamos en la secci√≥n de "Flujo", mostramos el gr√°fico de dona
    canvas.style.display = 'block'; // Aseguramos que el gr√°fico se muestre en "Flujo"
    mostrarGraficoGastos(data); // Llamamos a la funci√≥n para generar el gr√°fico
  }
  // Continuamos con la l√≥gica de la navegaci√≥n de resultados
  document.querySelectorAll('.resultado-categoria').forEach(div => div.classList.remove('active-res'));
  document.getElementById(id).classList.add('active-res');
  document.querySelectorAll('#navResultados .nav-res').forEach(nav => nav.classList.remove('active'));
  const current = Array.from(document.querySelectorAll('#navResultados .nav-res')).find(nav => nav.textContent.includes(id.replace('res', '')));
  if (current) current.classList.add('active');
}
function obtenerDatosFormulario() {
  const form = document.getElementById("calculadoraFormulario");
  const formData = {}; // üîµ usamos otro nombre para no confundir con data global

  Array.from(form.elements).forEach(el => {
    if (el.name) {
      let value = (el.type === "checkbox") ? el.checked : el.value;

      if (typeof value === "string" && value.trim() !== "" && !isNaN(value)) {
        value = parseFloat(value);
      }

      formData[el.name] = value;
    }
  });

  return formData;
}

// ‚úÖ Funci√≥n para guardar la data y avanzar al siguiente paso
function guardarDatosYAvanzar(nextStepName) {
  data = obtenerDatosFormulario(); // üîµ actualizamos data global
  console.log("‚úÖ Data capturada:", data); // üîç vemos en consola para asegurar
  nextStep(nextStepName); // üîµ avanzamos al siguiente paso
}
// ‚úÖ Funci√≥n para llenar los campos mostrados en stepRetiro
function llenarCamposRetiro(data) {
  console.log("‚úèÔ∏è Llenando campos de retiro con data:", data);

  const salarioTotal = 
    (parseFloat(data.salario) || 0) +
    (parseFloat(data.ingreso_negocio) || 0) +
    (parseFloat(data.bonos) || 0) +
    (parseFloat(data.dividendos_intereses) || 0) +
    (parseFloat(data.renta) || 0) +
    (parseFloat(data.otros_ingresos) || 0);

  // ‚úÖ Aqu√≠ s√≠ rellenamos correctamente los campos mostrados
  document.getElementById('salario_mostrado').value = salarioTotal.toFixed(2);
  document.getElementById('ahorro_retiro_mostrado').value = (parseFloat(data.cuentas_retiro) || 0).toFixed(2);
  document.getElementById('aporte_personal_mostrado').value = (parseFloat(data.aporte_personal_retiro) || 0).toFixed(2);
  document.getElementById('aporte_empleador_mostrado').value = (parseFloat(data.aporte_empleador_retiro) || 0).toFixed(2);
}
function procesarResultados() {
  data = obtenerDatosFormulario();
  console.log("‚úÖ Datos recopilados:", data);

  mostrarGraficoGastos(data);
  calcularResultados(data);
  document.getElementById("resultadosContainer").style.display = "block";
  mostrarResultado("resA");
}

function calcularCategoriaA(data) {
  // üîπ Ingreso total
  const ingresoAnual =
    (data.salario || 0) +
    (data.ingreso_negocio || 0) +
    (data.otros_ingresos || 0) +
    (data.bonos || 0) +
    (data.dividendos_intereses || 0) +
    (data.renta || 0);
  const ingresoMensual = ingresoAnual / 12;

  // üîπ Ahorro
  const ahorroAnual =
    (data.aporte_personal_retiro || 0) +
    (data.aporte_empleador_retiro || 0) +
    (data.otros_ahorros || 0);
  const ahorroMensual = ahorroAnual / 12;

  // üîπ Seguros
  const segurosAnual =
    (data.seguro_vida || 0) +
    (data.seguro_medico || 0) +
    (data.seguro_incapacidad || 0) +
    (data.seguro_ltc || 0) +
    (data.seguro_propiedad || 0) +
    (data.seguro_auto || 0) +
    (data.seguro_umbrella || 0) +
    (data.seguro_renta || 0) +
    (data.seguro_propiedad_personal || 0);
  const segurosMensual = segurosAnual / 12;

  // üîπ Impuestos
  const impuestosAnual =
    (data.impuesto_federal || 0) +
    (data.impuesto_propiedad || 0) +
    (data.impuesto_auto || 0) +
    (data.impuesto_estatal_local || 0) +
    (data.seguro_social || 0) +
    (data.medicare || 0);
  const impuestosMensual = impuestosAnual / 12;

  // üîπ Gastos diarios esenciales
  const gastosEsencialesAnual =
    (data.supermercado || 0) +
    (data.comidas_afuera || 0) +
    (data.telecomunicaciones || 0) +
    (data.servicio_publico || 0) +
    (data.mantenimiento_auto || 0) +
    (data.mantenimiento_hogar || 0) +
    (data.cuidado_hijos || 0) +
    (data.cuidado_personal || 0);
  const gastosEsencialesMensual = gastosEsencialesAnual / 12;

  // üîπ Gastos diarios totales (todos los gastos listados en imagen)
  const gastosTotalesAnual =
    (data.servicio_publico || 0) +
    (data.cuidado_hijos || 0) +
    (data.mantenimiento_auto || 0) +
    (data.cuidado_personal || 0) +
    (data.supermercado || 0) +
    (data.comidas_afuera || 0) +
    (data.ropa || 0) +
    (data.vacaciones || 0) +
    (data.muebles_enseres || 0) +
    (data.gastos_medicos || 0) +
    (data.telecomunicaciones || 0) +
    (data.mantenimiento_hogar || 0) +
    (data.entretenimiento || 0) +
    (data.libros_membresia || 0) +
    (data.regalos_mesada || 0) +
    (data.donaciones || 0) +
    (data.fiestas || 0) +
    (data.mejoras_hogar || 0) +
    (data.dues || 0) +
    (data.servicios_profesionales || 0) +
    (data.gastos_mascota || 0) +
    (data.otros_gastos_diarios || 0);
  const gastosTotalesMensual = gastosTotalesAnual / 12;

  // üîπ Servicio de deuda
  const deudaAnual =
    (data.hipoteca || 0) +
    (data.prestamo_auto || 0) +
    (data.prestamo_educativo || 0) +
    (data.prestamo_personal || 0) +
    (data.linea_credito || 0) +
    (data.manutencion || 0) +
    (data.tarjetas_credito || 0) +
    (data.otros_deuda || 0);
  const deudaMensual = deudaAnual / 12;

  // üîπ Total egresos y super√°vit
  const egresosAnual = impuestosAnual + segurosAnual + gastosEsencialesAnual + deudaAnual + ahorroAnual;
  const egresosMensual = egresosAnual / 12;
  const superavitAnual = ingresoAnual - egresosAnual;
  const superavitMensual = ingresoMensual - egresosMensual;

  // üîπ Indicadores de liquidez
  const activosLiquidos = (data.cuentas_bancarias || 0) + (data.cuentas_inversion || 0);
  const activosTotales =
    activosLiquidos +
    (data.cuentas_retiro || 0) +
    (data.valor_vivienda || 0) +
    (data.valor_propiedades_alquiler || 0) +
    (data.valor_vehiculos || 0) +
    (data.valor_otros_activos || 0) +
    (data.valor_otros || 0);

  const razonCorriente = activosLiquidos / ((data.deuda_tarjetas || 1));
  const efectivoSobreActivos = ((data.cuentas_bancarias || 0) / activosTotales) * 100;
  const mesesReserva = (data.cuentas_bancarias || 0) / (impuestosMensual + segurosMensual + gastosEsencialesMensual + deudaMensual || 1);

  const emojiAhorro = ahorroAnual / ingresoAnual >= 0.3 ? "‚úÖ" : (ahorroAnual / ingresoAnual >= 0.15 ? "‚ö†Ô∏è" : "üö®");
  const emojiReserva = mesesReserva >= 12 ? "‚úÖ" : (mesesReserva >= 6 ? "‚ö†Ô∏è" : "üö®");
  const emojiCorriente = razonCorriente >= 1 ? "‚úÖ" : "üö®";
  const emojiEfectivo = efectivoSobreActivos < 5 ? "‚ö†Ô∏è" : (efectivoSobreActivos > 20 ? "üîÅ" : "‚úÖ");

  const tabla = `
  <table style="font-size: 0.95em; width: 100%; border-collapse: separate; border-spacing: 0 8px;">
    <thead>
      <tr style="text-align: center;">
        <th style="text-align: left;">Indicador</th>
        <th style="text-align: center;">Anual</th>
        <th style="text-align: center;">Mensual</th>
        <th style="text-align: center;">Evaluaci√≥n</th>
      </tr>
    </thead>
    <tbody>
      <tr><td>Ingreso total</td><td>$${ingresoAnual.toLocaleString()}</td><td>$${ingresoMensual.toFixed(2)}</td><td>‚Äì</td></tr>
      <tr><td>Gastos diarios (solo esenciales)</td><td>$${gastosEsencialesAnual.toLocaleString()}</td><td>$${gastosEsencialesMensual.toFixed(2)}</td><td>‚Äì</td></tr>
      <tr><td>Gastos diarios (totales)</td><td>$${gastosTotalesAnual.toLocaleString()}</td><td>$${gastosTotalesMensual.toFixed(2)}</td><td>‚Äì</td></tr>
      <tr><td>Impuestos</td><td>$${impuestosAnual.toLocaleString()}</td><td>$${impuestosMensual.toFixed(2)}</td><td>‚Äì</td></tr>
      <tr><td>Seguros</td><td>$${segurosAnual.toLocaleString()}</td><td>$${segurosMensual.toFixed(2)}</td><td>‚Äì</td></tr>
      <tr><td>Servicio de deuda</td><td>$${deudaAnual.toLocaleString()}</td><td>$${deudaMensual.toFixed(2)}</td><td>‚Äì</td></tr>
      <tr><td><strong>Total egresos (incluye ahorro)</strong></td><td><strong>$${egresosAnual.toLocaleString()}</strong></td><td><strong>$${egresosMensual.toFixed(2)}</strong></td><td>‚Äì</td></tr>
      <tr><td>Ahorro</td><td>$${ahorroAnual.toLocaleString()}</td><td>$${ahorroMensual.toFixed(2)}</td><td>${emojiAhorro}</td></tr>
      <tr><td>Super√°vit</td><td>$${superavitAnual.toLocaleString()}</td><td>$${superavitMensual.toFixed(2)}</td><td>‚Äì</td></tr>
      <tr><td>Meses de reserva</td><td colspan="2">${mesesReserva.toFixed(1)} meses</td><td>${emojiReserva}</td></tr>
      <tr><td>Raz√≥n corriente</td><td colspan="2">${razonCorriente.toFixed(2)}</td><td>${emojiCorriente}</td></tr>
      <tr><td>Efectivo / activos totales</td><td colspan="2">${efectivoSobreActivos.toFixed(1)}%</td><td>${emojiEfectivo}</td></tr>
    </tbody>
  </table>
  <p style="font-size: 0.85em; color: gray; text-align: center; margin-top: 10px;">
    ‚úÖ Dentro del rango ideal &nbsp;&nbsp; ‚ö†Ô∏è Aceptable o mejorable &nbsp;&nbsp; üö® Riesgo o alerta &nbsp;&nbsp; üîÅ Exceso conservador
  </p>
  `;

  document.getElementById("resA").innerHTML = `
    <h3>üÖ∞Ô∏è A. Flujo de efectivo y liquidez</h3>
    ${tabla}
  `;
}

function calcularCategoriaB(data) {
  // üîπ Ingresos
  const ingresoBruto = (data.salario || 0) + (data.ingreso_negocio || 0);
  const ingresoNeto = ingresoBruto * 0.80; // Estimaci√≥n de ingreso neto

  // üîπ Gasto de vivienda (s√≥lo componentes de vivienda)
  const gastoVivienda = 
    (data.hipoteca || 0) +
    (data.impuesto_propiedad || 0) +
    (data.seguro_propiedad || 0);

  const porcentajeViviendaNeto = (gastoVivienda / ingresoNeto) * 100;
  const porcentajeViviendaBruto = (gastoVivienda / ingresoBruto) * 100;

  // üîπ Servicio de deuda
  const servicioDeuda = 
    (data.hipoteca || 0) +
    (data.prestamo_auto || 0) +
    (data.prestamo_educativo || 0) +
    (data.prestamo_personal || 0) +
    (data.linea_credito || 0) +
    (data.manutencion || 0) +
    (data.tarjetas_credito || 0) +
    (data.otros_deuda || 0);

  const dtiNeto = (servicioDeuda / ingresoNeto) * 100;
  const dtiBruto = (servicioDeuda / ingresoBruto) * 100;

  // üîπ Gastos esenciales anuales = Pasivos corrientes
  const pasivosCorrientes =
    (data.impuesto_federal || 0) +
    (data.impuesto_propiedad || 0) +
    (data.impuesto_auto || 0) +
    (data.impuesto_estatal_local || 0) +
    (data.seguro_social || 0) +
    (data.medicare || 0) +
    (data.seguro_vida || 0) +
    (data.seguro_medico || 0) +
    (data.seguro_incapacidad || 0) +
    (data.seguro_ltc || 0) +
    (data.seguro_propiedad || 0) +
    (data.seguro_auto || 0) +
    (data.seguro_umbrella || 0) +
    (data.seguro_renta || 0) +
    (data.seguro_propiedad_personal || 0) +
    (data.hipoteca || 0) +
    (data.prestamo_auto || 0) +
    (data.prestamo_educativo || 0) +
    (data.prestamo_personal || 0) +
    (data.linea_credito || 0) +
    (data.manutencion || 0) +
    (data.tarjetas_credito || 0) +
    (data.otros_deuda || 0) +
    (data.supermercado || 0) +
    (data.comidas_afuera || 0) +
    (data.transporte || 0) +
    (data.telecomunicaciones || 0) +
    (data.servicio_publico || 0) +
    (data.mantenimiento_auto || 0) +
    (data.mantenimiento_hogar || 0) +
    (data.cuidado_hijos || 0) +
    (data.cuidado_personal || 0);

  // üîπ Total deudas (s√≥lo saldos)
  const deudas = 
    (data.deuda_tarjetas || 0) +
    (data.deuda_vehiculos || 0) +
    (data.deuda_comercial || 0) +
    (data.deuda_hipotecaria || 0) +
    (data.deuda_estudios || 0) +
    (data.deuda_otros || 0);

  const pasivosTotales = deudas + pasivosCorrientes;

  // üîπ Activos totales
  const activosTotales =
    (data.cuentas_bancarias || 0) +
    (data.cuentas_inversion || 0) +
    (data.cuentas_retiro || 0) +
    (data.valor_vivienda || 0) +
    (data.valor_propiedades_alquiler || 0) +
    (data.valor_vehiculos || 0) +
    (data.valor_otros_activos || 0) +
    (data.valor_otros || 0);

  const patrimonioNeto = activosTotales - pasivosTotales;

  // üîπ Indicadores
  const relacionPasivosCorrientes = (pasivosCorrientes / activosTotales) * 100;
  const relacionDeudaActivos = (pasivosTotales / activosTotales) * 100;
  const relacionDeudaPatrimonio = (pasivosTotales / patrimonioNeto) * 100;

  // üîπ Emojis evaluaci√≥n
  const emojiViviendaNeto = porcentajeViviendaNeto <= 28 ? '‚úÖ' : 'üö®';
  const emojiViviendaBruto = porcentajeViviendaBruto <= 24 ? '‚úÖ' : 'üö®';
  const emojiDTINeto = dtiNeto <= 36 ? '‚úÖ' : 'üö®';
  const emojiDTIBruto = dtiBruto <= 30 ? '‚úÖ' : 'üö®';
  const emojiPasivosCorr = relacionPasivosCorrientes <= 20 ? '‚úÖ' : '‚ö†Ô∏è';
  const emojiDeudaActivos = relacionDeudaActivos <= 50 ? '‚úÖ' : '‚ö†Ô∏è';
  const emojiDeudaPatrimonio = 
    relacionDeudaPatrimonio <= 50 ? '‚úÖ' :
    relacionDeudaPatrimonio <= 100 ? '‚ö†Ô∏è' : 'üö®';

  // üîπ Tabla
  const tabla = `
    <table style="font-size: 0.95em; width: 100%; border-collapse: separate; border-spacing: 0 8px;">
      <thead>
        <tr style="text-align: center;">
          <th style="text-align: left;">Indicador</th>
          <th style="text-align: center;">Resultado</th>
          <th style="text-align: center;">Evaluaci√≥n</th>
        </tr>
      </thead>
      <tbody>
        <tr><td>Activos totales</td><td style="text-align: center;">$${activosTotales.toLocaleString()}</td><td style="text-align: center;">‚Äì</td></tr>
        <tr><td>Pasivos totales (incluye gastos esenciales)</td><td style="text-align: center;">$${pasivosTotales.toLocaleString()}</td><td style="text-align: center;">‚Äì</td></tr>
        <tr><td>% Vivienda / ingreso neto</td><td style="text-align: center;">${porcentajeViviendaNeto.toFixed(1)}%</td><td style="text-align: center;">${emojiViviendaNeto}</td></tr>
        <tr><td>% Vivienda / ingreso bruto</td><td style="text-align: center;">${porcentajeViviendaBruto.toFixed(1)}%</td><td style="text-align: center;">${emojiViviendaBruto}</td></tr>
        <tr><td>DTI / ingreso neto</td><td style="text-align: center;">${dtiNeto.toFixed(1)}%</td><td style="text-align: center;">${emojiDTINeto}</td></tr>
        <tr><td>DTI / ingreso bruto</td><td style="text-align: center;">${dtiBruto.toFixed(1)}%</td><td style="text-align: center;">${emojiDTIBruto}</td></tr>
        <tr><td>Pasivos corrientes / activos</td><td style="text-align: center;">${relacionPasivosCorrientes.toFixed(1)}%</td><td style="text-align: center;">${emojiPasivosCorr}</td></tr>
        <tr><td>Deuda total / activos</td><td style="text-align: center;">${relacionDeudaActivos.toFixed(1)}%</td><td style="text-align: center;">${emojiDeudaActivos}</td></tr>
        <tr><td>Deuda total / patrimonio neto</td><td style="text-align: center;">${relacionDeudaPatrimonio.toFixed(1)}%</td><td style="text-align: center;">${emojiDeudaPatrimonio}</td></tr>
      </tbody>
    </table>

    <h4 style="margin-top: 20px;">üìä Benchmarks utilizados</h4>
    <ul style="font-size: 0.9em;">
      <li>Vivienda / ingreso neto: ‚â§ 28% ‚úÖ</li>
      <li>Vivienda / ingreso bruto: ‚â§ 24% ‚úÖ</li>
      <li>DTI neto: ‚â§ 36% ‚úÖ</li>
      <li>DTI bruto: ‚â§ 30% ‚úÖ</li>
      <li>Pasivos corrientes / activos: ‚â§ 20% ‚úÖ</li>
      <li>Deuda / activos: ‚â§ 50% ‚úÖ</li>
      <li>Deuda / patrimonio neto: ‚â§ 50% ‚úÖ ¬∑ 51‚Äì100% ‚ö†Ô∏è ¬∑ > 100% üö®</li>
    </ul>
  `;

  document.getElementById("resB").innerHTML = `
    <h3>üÖ±Ô∏è B. Endeudamiento</h3>
    ${tabla}
  `;
}

function calcularCategoriaC(data) {
  // üîπ Activos
  const totalActivos =
    (data.cuentas_bancarias || 0) +
    (data.cuentas_inversion || 0) +
    (data.cuentas_retiro || 0) +
    (data.valor_vivienda || 0) +
    (data.valor_propiedades_alquiler || 0) +
    (data.valor_vehiculos || 0) +
    (data.valor_otros_activos || 0) +
    (data.valor_otros || 0);

  // üîπ Pasivos
  const totalPasivos =
    (data.deuda_hipotecaria || 0) +
    (data.deuda_tarjetas || 0) +
    (data.deuda_vehiculos || 0) +
    (data.deuda_comercial || 0) +
    (data.deuda_estudios || 0) +
    (data.deuda_otros || 0) +
    (data.linea_credito || 0);

  // üîπ C√°lculo de patrimonio neto
  const patrimonioNeto = totalActivos - totalPasivos;

  // üîπ Ratios
  const ratioPatrimonioActivos = (patrimonioNeto / totalActivos) * 100;
  const ratioPatrimonioPasivos = (patrimonioNeto / totalPasivos) * 100;

  // üîπ Evaluaci√≥n con emojis
  const emojiActivos = ratioPatrimonioActivos >= 70 ? '‚úÖ' :
                       ratioPatrimonioActivos >= 50 ? '‚ö†Ô∏è' : 'üö®';

  const emojiPasivos = ratioPatrimonioPasivos >= 200 ? '‚úÖ' :
                       ratioPatrimonioPasivos >= 100 ? '‚ö†Ô∏è' : 'üö®';

  // üîπ Tabla visual con resultados
  const tabla = `
    <table style="font-size: 0.95em; margin-top: 10px;">
      <thead>
        <tr><th>Indicador</th><th>Resultado</th><th>Evaluaci√≥n</th></tr>
      </thead>
      <tbody>
        <tr><td>Activos totales</td><td>$${totalActivos.toLocaleString()}</td><td>‚Äì</td></tr>
        <tr><td>Pasivos totales</td><td>$${totalPasivos.toLocaleString()}</td><td>‚Äì</td></tr>
        <tr><td>Patrimonio neto</td><td>$${patrimonioNeto.toLocaleString()}</td><td>‚Äì</td></tr>
        <tr><td>Relaci√≥n patrimonio / activos</td><td>${ratioPatrimonioActivos.toFixed(1)}%</td><td>${emojiActivos}</td></tr>
        <tr><td>Relaci√≥n patrimonio / pasivos</td><td>${ratioPatrimonioPasivos.toFixed(1)}%</td><td>${emojiPasivos}</td></tr>
      </tbody>
    </table>

    <h4 style="margin-top: 20px;">üìä Benchmarks utilizados</h4>
    <ul style="font-size: 0.9em;">
      <li><strong>Relaci√≥n patrimonio / activos:</strong>
        ‚â• 70% ‚úÖ ¬∑ 50‚Äì69% ‚ö†Ô∏è ¬∑ &lt; 50% üö®
      </li>
      <li><strong>Relaci√≥n patrimonio / pasivos:</strong>
        ‚â• 200% ‚úÖ ¬∑ 100‚Äì199% ‚ö†Ô∏è ¬∑ &lt; 100% üö®
      </li>
      <li><strong>Patrimonio neto absoluto:</strong>
        Evaluado en funci√≥n de edad, ingresos y metas.
      </li>
    </ul>
  `;

  // Mostrar resultados
  document.getElementById("resC").innerHTML = `
    <h3>üÖ≤ C. Patrimonio neto</h3>
    ${tabla}
  `;
}
function calcularCategoriaD(data) {
  // üîπ Ingreso y ahorro
  const ingresoAnualBruto = (data.salario || 0) + (data.ingreso_negocio || 0) + (data.otros_ingresos || 0) + (data.bonos || 0) + (data.dividendos_intereses || 0) + (data.renta || 0);
  const ingresoMensual = ingresoAnualBruto / 12;
  const ahorroAnual = (data.aporte_personal_retiro || 0) + (data.aporte_empleador_retiro || 0) + (data.otros_ahorros || 0);
  const tasaAhorro = (ahorroAnual / ingresoAnualBruto) * 100;

  // üîπ Gastos esenciales anuales
  const gastosEsencialesAnual = 
    (data.servicio_publico || 0) +
    (data.mantenimiento_auto || 0) +
    (data.cuidado_hijos || 0) +
    (data.supermercado || 0) +
    (data.comidas_afuera || 0) +
    (data.telecomunicaciones || 0) +
    (data.mantenimiento_hogar || 0) +
    (data.cuidado_personal || 0) +
    (data.impuesto_federal || 0) +
    (data.impuesto_propiedad || 0) +
    (data.impuesto_auto || 0) +
    (data.impuesto_estatal_local || 0) +
    (data.seguro_vida || 0) +
    (data.seguro_medico || 0) +
    (data.seguro_incapacidad || 0) +
    (data.seguro_ltc || 0) +
    (data.seguro_propiedad || 0) +
    (data.seguro_auto || 0) +
    (data.seguro_umbrella || 0) +
    (data.seguro_renta || 0) +
    (data.seguro_propiedad_personal || 0) +
    (data.hipoteca || 0) +
    (data.prestamo_auto || 0) +
    (data.prestamo_educativo || 0) +
    (data.prestamo_personal || 0) +
    (data.linea_credito || 0) +
    (data.tarjetas_credito || 0) +
    (data.otros_deuda || 0) +
    (data.manutencion || 0);

  const gastosEsencialesMensual = gastosEsencialesAnual / 12;

  // üîπ Activos
  const activosDeInversion = (data.cuentas_inversion || 0) + (data.cuentas_retiro || 0) + (data.valor_propiedades_alquiler || 0);
  const activosTotales = 
    (data.cuentas_bancarias || 0) +
    (data.cuentas_inversion || 0) +
    (data.cuentas_retiro || 0) +
    (data.valor_vivienda || 0) +
    (data.valor_propiedades_alquiler || 0) +
    (data.valor_vehiculos || 0) +
    (data.valor_otros_activos || 0) +
    (data.valor_otros || 0);

  const pasivosTotales =
    (data.deuda_hipotecaria || 0) + (data.deuda_tarjetas || 0) +
    (data.deuda_comercial || 0) + (data.deuda_vehiculos || 0) +
    (data.deuda_estudios || 0) + (data.deuda_otros || 0) + (data.linea_credito || 0);

  const patrimonioNeto = activosTotales - pasivosTotales;

  // üîπ Indicadores clave
  const activosInversionSobreTotales = (activosDeInversion / activosTotales) * 100;
  const activosInversionSobreIngreso = activosDeInversion / ingresoAnualBruto;
  const activosInversionSobreGastos = activosDeInversion / gastosEsencialesMensual;
  const patrimonioSobreIngreso = patrimonioNeto / ingresoAnualBruto;

  // üîπ Capacidad de acumulaci√≥n
  const superavit = ingresoAnualBruto - gastosEsencialesAnual - ahorroAnual;
  const capacidadAcumulacion = (ahorroAnual + superavit) / ingresoAnualBruto * 100;

  // üîπ Benchmarks edad ‚Üí 45 a√±os ‚Üí 4.5x
  const benchmarkEdad = 4.5;

  // üîπ Emojis
  const emojiAhorro = tasaAhorro >= 30 ? '‚úÖ' : (tasaAhorro >= 15 ? '‚ö†Ô∏è' : 'üö®');
  const emojiCapacidad = capacidadAcumulacion >= 30 ? '‚úÖ' : (capacidadAcumulacion >= 15 ? '‚ö†Ô∏è' : 'üö®');
  const emojiInversionTotales = activosInversionSobreTotales >= 50 ? '‚úÖ' : (activosInversionSobreTotales >= 30 ? '‚ö†Ô∏è' : 'üö®');
  const emojiInversionIngreso = activosInversionSobreIngreso >= 1.6 ? '‚úÖ' : (activosInversionSobreIngreso >= 0.6 ? '‚ö†Ô∏è' : 'üö®');
  const emojiInversionGastos = activosInversionSobreGastos >= 120 ? '‚úÖ' : (activosInversionSobreGastos >= 60 ? '‚ö†Ô∏è' : 'üö®');
  const emojiPatrimonioIngreso = patrimonioSobreIngreso >= benchmarkEdad ? '‚úÖ' : (patrimonioSobreIngreso >= benchmarkEdad * 0.8 ? '‚ö†Ô∏è' : 'üö®');

  // üîπ Tabla visual
  const tabla = `
    <table style="font-size: 0.95em; margin-top: 10px;">
      <thead>
        <tr><th>Indicador</th><th>Resultado</th><th>Evaluaci√≥n</th></tr>
      </thead>
      <tbody>
        <tr><td>Tasa de ahorro (retirement)</td><td>${tasaAhorro.toFixed(1)}%</td><td>${emojiAhorro}</td></tr>
        <tr><td>Capacidad de acumulaci√≥n</td><td>${capacidadAcumulacion.toFixed(1)}%</td><td>${emojiCapacidad}</td></tr>
        <tr><td>Activos de inversi√≥n / activos totales</td><td>${activosInversionSobreTotales.toFixed(1)}%</td><td>${emojiInversionTotales}</td></tr>
        <tr><td>Activos de inversi√≥n / ingreso bruto anual</td><td>${activosInversionSobreIngreso.toFixed(2)}x</td><td>${emojiInversionIngreso}</td></tr>
        <tr><td>Activos de inversi√≥n / gastos esenciales</td><td>${activosInversionSobreGastos.toFixed(0)} meses</td><td>${emojiInversionGastos}</td></tr>
        <tr><td>Patrimonio neto / ingreso bruto anual</td><td>${patrimonioSobreIngreso.toFixed(2)}x</td><td>${emojiPatrimonioIngreso}</td></tr>
      </tbody>
    </table>

    <h4 style="margin-top: 20px;">üìä Benchmarks utilizados</h4>
    <ul style="font-size: 0.9em;">
      <li>Tasa de ahorro: ‚â• 30% ‚úÖ ¬∑ 15‚Äì29% ‚ö†Ô∏è ¬∑ < 15% üö®</li>
      <li>Capacidad de acumulaci√≥n: ‚â• 30% ‚úÖ ¬∑ 15‚Äì29% ‚ö†Ô∏è ¬∑ < 15% üö®</li>
      <li>Activos de inversi√≥n / activos totales: ‚â• 50% ‚úÖ ¬∑ 30‚Äì49% ‚ö†Ô∏è ¬∑ < 30% üö®</li>
      <li>Activos de inversi√≥n / ingreso bruto anual: ‚â• 1.6x ‚úÖ ¬∑ 0.6‚Äì1.59x ‚ö†Ô∏è ¬∑ < 0.6x üö®</li>
      <li>Activos de inversi√≥n / gastos esenciales mensuales: ‚â• 120 meses ‚úÖ ¬∑ 60‚Äì119 ‚ö†Ô∏è ¬∑ < 60 üö®</li>
      <li>Patrimonio neto / ingreso bruto anual: ‚â• ${benchmarkEdad}x ‚úÖ ¬∑ ‚â• ${(benchmarkEdad * 0.8).toFixed(1)}x ‚ö†Ô∏è</li>
    </ul>
  `;

  document.getElementById("resD").innerHTML = `
    <h3>üÖ≥ D. Seguridad financiera</h3>
    ${tabla}
  `;
}

function calcularCategoriaE(data) {
  // üîπ Gastos mensuales esenciales
  const gastosEsencialesMensuales = (
    (data.supermercado || 0) +
    (data.transporte || 0) +
    (data.telecomunicaciones || 0) +
    (data.servicio_publico || 0) +
    (data.seguro_medico || 0) +
    (data.seguro_propiedad || 0) +
    (data.seguro_auto || 0) +
    (data.educacion || 0) +
    (data.impuesto_federal || 0) +
    (data.impuesto_propiedad || 0) +
    (data.seguro_social || 0) +
    (data.hipoteca || 0) +
    (data.linea_credito || 0) +
    (data.prestamo_auto || 0) +
    (data.tarjetas_credito || 0) +
    (data.otros_deuda || 0)
  ) / 12;

  // üîπ C√°lculo de activos con descuentos por liquidez
  const cuentasLiquidas = (data.cuentas_bancarias || 0) + (data.cuentas_inversion || 0); // 100%
  const activosReales = ((data.valor_vivienda || 0) + (data.valor_propiedades_alquiler || 0) + (data.valor_otros_activos || 0)) * 0.8;
  const activosMenosLiquidos = ((data.valor_vehiculos || 0) + (data.valor_otros || 0)) * 0.5;
  const cuentasRetiro = (data.cuentas_retiro || 0); // 100%, pero solo en total

  // üîπ C√°lculo de meses por tipo
  const mesesLiquidos = cuentasLiquidas / gastosEsencialesMensuales;
  const mesesReales = activosReales / gastosEsencialesMensuales;
  const mesesMenosLiquidos = activosMenosLiquidos / gastosEsencialesMensuales;
  const mesesRetiro = cuentasRetiro / gastosEsencialesMensuales;

  const totalSinRetiro = mesesLiquidos + mesesReales + mesesMenosLiquidos;
  const totalConRetiro = totalSinRetiro + mesesRetiro;

  // üîπ Checklist
  const checklist = {
    'Seguro m√©dico': data.seguro_medico ? '‚úÖ S√≠' : '‚ùå No',
    'Seguro de vida': data.seguro_vida ? '‚úÖ S√≠' : '‚ùå No',
    'Seguros clave (discapacidad, hogar, auto, umbrella)': (
      data.seguro_incapacidad || data.seguro_hogar || data.seguro_auto || data.seguro_umbrella
    ) ? '‚úÖ S√≠' : '‚ùå No',
    'Fondos de contingencia alternativos': data.fondos_contingencia_alternativos ? '‚úÖ S√≠' : '‚ùå No',
    'Diversificaci√≥n de ingresos': data.diversificacion_ingresos ? '‚úÖ S√≠' : '‚ùå No',
    'Provisi√≥n para eventos inesperados': data.provision_eventos ? '‚úÖ S√≠' : '‚ùå No'
  };

  // üîπ Output visual
  const barras = `
    <div style="background-color:#007bff;height:20px;width:${(mesesLiquidos / totalConRetiro * 100).toFixed(1)}%"></div>
    <p>Cuentas l√≠quidas (100%): ${mesesLiquidos.toFixed(1)} meses</p>
    <div style="background-color:#00bfae;height:20px;width:${(mesesReales / totalConRetiro * 100).toFixed(1)}%"></div>
    <p>Activos reales (80%): ${mesesReales.toFixed(1)} meses</p>
    <div style="background-color:#ffdd57;height:20px;width:${(mesesMenosLiquidos / totalConRetiro * 100).toFixed(1)}%"></div>
    <p>Activos menos l√≠quidos (50%): ${mesesMenosLiquidos.toFixed(1)} meses</p>
    <div style="background-color:#6c757d;height:20px;width:${(mesesRetiro / totalConRetiro * 100).toFixed(1)}%"></div>
    <p>Cuentas de retiro: ${mesesRetiro.toFixed(1)} meses</p>
  `;

  const checklistHTML = Object.entries(checklist)
    .map(([key, val]) => `<li><strong>${key}:</strong> ${val}</li>`)
    .join('');

  document.getElementById("resE").innerHTML = `
    <h3>üÖ¥ E. Manejo de riesgo</h3>
    <p><strong>Fondos de contingencia inmediatos (sin retiro):</strong> ${totalSinRetiro.toFixed(1)} meses</p>
    <p><strong>Fondos totales incluyendo cuentas de retiro:</strong> ${totalConRetiro.toFixed(1)} meses</p>

    <h4>Barras de cobertura por tipo de activo</h4>
    ${barras}

    <h4 style="margin-top: 20px;">üìã Checklist de cobertura y resiliencia</h4>
    <ul style="font-size: 0.9em;">${checklistHTML}</ul>
  `;
}

function calcularCategoriaF(data) {
  // Lista de documentos
  const documentos = [
    { nombre: "Trust", tiene: data.trust },
    { nombre: "Testamento", tiene: data.will },
    { nombre: "Directiva m√©dica anticipada", tiene: data.advance_medical_directive },
    { nombre: "Poder legal", tiene: data.power_of_attorney },
    { nombre: "Designaci√≥n de beneficiarios", tiene: data.beneficiary_designation },
    { nombre: "T√≠tulos de propiedad", tiene: data.property_deeds }
  ];

  // Separar documentos en los que tiene y los que faltan
  const tiene = documentos.filter(doc => doc.tiene).map(doc => doc.nombre);
  const faltan = documentos.filter(doc => !doc.tiene).map(doc => doc.nombre);

  // Mostrar los resultados
  document.getElementById("resF").innerHTML = `
    <h3>üÖµ F. Planificaci√≥n patrimonial</h3>

    <h4>‚úÖ Documentos que tiene</h4>
    <ul style="font-size: 0.9em;">
      ${tiene.length > 0 ? tiene.map(doc => `<li>${doc}</li>`).join('') : '<li>No tiene documentos registrados.</li>'}
    </ul>

    <h4>‚ùå Documentos que faltan</h4>
    <ul style="font-size: 0.9em;">
      ${faltan.length > 0 ? faltan.map(doc => `<li>${doc}</li>`).join('') : '<li>Todos los documentos est√°n completos.</li>'}
    </ul>
  `;
}

// ‚úÖ SECCI√ìN G: C√°lculo de retiro con gr√°fico comparativo + simulaci√≥n Monte Carlo + tooltip
function calcularCategoriaG(data) {
  const edadActual = data.edad;
  const edadRetiro = data.edad_retiro;
  const anosAcumulacion = edadRetiro - edadActual;
  const anosDistribucion = 100 - edadRetiro;

  const salarioBase = 
  (data.salario || 0) +
  (data.ingreso_negocio || 0) +
  (data.bonos || 0) +
  (data.dividendos_intereses || 0) +
  (data.renta || 0) +
  (data.otros_ingresos || 0);
  const porcentajeReemplazo = (data.porcentaje_reemplazo || 70) / 100;
  const ingresoDeseadoBase = salarioBase * porcentajeReemplazo;
  const ingresoSeguro = data.ingreso_seguro_social || 0;
  const ingresoDeseadoNeto = Math.max(ingresoDeseadoBase - ingresoSeguro, 0);
  const ingresoRequerido = ingresoDeseadoNeto * Math.pow(1 + (data.inflacion_esperada || 0) / 100, anosAcumulacion);

  const tasaInflacion = (data.inflacion_esperada || 0) / 100;
  const tasaAcumulacionNominal = (data.tasa_acumulacion || 0) / 100;
  const tasaDistribucionNominal = (data.tasa_retiro || 0) / 100;

  const tasaRealDistribucion = (1 + tasaDistribucionNominal) / (1 + tasaInflacion) - 1;
  const tasaRealAcumulacion = (1 + tasaAcumulacionNominal) / (1 + tasaInflacion) - 1;

  const factorOrdinario = (1 - Math.pow(1 + tasaRealDistribucion, -anosDistribucion)) / tasaRealDistribucion;
  const factorAnticipado = factorOrdinario * (1 + tasaRealDistribucion);
  const necesidadFondo = ingresoRequerido * factorAnticipado;

  const fondoActual = data.cuentas_retiro || 0;
  const aportesAnuales = (data.aporte_personal_retiro || 0) + (data.aporte_empleador_retiro || 0);
  const ahorroFuturo = fondoActual * Math.pow(1 + tasaRealAcumulacion, anosAcumulacion);
  const aportesFuturos = aportesAnuales * ((Math.pow(1 + tasaRealAcumulacion, anosAcumulacion) - 1) / tasaRealAcumulacion);
  const montoEsperado = ahorroFuturo + aportesFuturos;

  const montoFaltante = necesidadFondo - montoEsperado;
  const ahorroRequeridoAnual = montoFaltante > 0
    ? montoFaltante * tasaRealAcumulacion / ((1 + tasaRealAcumulacion) ** anosAcumulacion - 1)
    : 0;
  const ahorroRequeridoMensual = ahorroRequeridoAnual / 12;

  let emojiResultado = "‚úÖ";
  if (montoEsperado / necesidadFondo < 0.7) emojiResultado = "üö®";
  else if (montoEsperado / necesidadFondo < 0.9) emojiResultado = "‚ö†Ô∏è";

  const interpretacion =
    emojiResultado === "‚úÖ"
      ? "Est√°s en buen camino hacia un retiro s√≥lido."
      : emojiResultado === "‚ö†Ô∏è"
      ? "Tu retiro muestra brechas importantes. Considera aumentar tus ahorros."
      : "Tu retiro est√° en riesgo. Se requieren ajustes importantes.";

  document.getElementById("resG").innerHTML = `
    <h3>üÖ∂ G. Futuro financiero</h3>
    <div class="resultado-bloque">
      <h2>${emojiResultado} Resultados calculados</h2>
      <table>
        <tr><td>üß± <strong>Capital necesario:</strong></td><td>$${necesidadFondo.toLocaleString()}</td></tr>
        <tr><td>üíº <strong>Total acumulado estimado:</strong></td><td>$${montoEsperado.toLocaleString()}</td></tr>
        <tr><td>‚ö†Ô∏è <strong>Faltante actual:</strong></td><td>${montoFaltante > 0 ? "$" + montoFaltante.toLocaleString() : "Meta alcanzada"}</td></tr>
        <tr><td>üí∏ <strong>Aporte anual recomendado extra:</strong></td><td>${ahorroRequeridoAnual > 0 ? "$" + ahorroRequeridoAnual.toFixed(2).toLocaleString() + "/a√±o" : "No requerido"}</td></tr>
        <tr><td>üí∞ <strong>Aporte mensual recomendado extra:</strong></td><td>${ahorroRequeridoMensual > 0 ? "$" + ahorroRequeridoMensual.toFixed(2).toLocaleString() + "/mes" : "No requerido"}</td></tr>
      </table>
      <canvas id="graficoRetiro" height="180" style="margin-top: 25px;"></canvas>
      <p><strong>üîç Interpretaci√≥n:</strong> ${interpretacion}</p>
      <div style="margin-top: 10px;">
        <span id="btnTooltipExplicacionMonteCarlo" style="cursor: pointer; color: #2563eb; text-decoration: underline;">
          üìò ¬øC√≥mo leer esto?
        </span>
        <div id="explicacionMonteCarlo" style="display: none; margin-top: 8px; background: #f1f5f9; padding: 10px; border-radius: 8px; font-size: 0.95em;">
          üîµ <strong>P50</strong> representa el escenario m√°s probable: en el <strong>50% de los casos</strong>, podr√≠as llegar a los <strong>100 a√±os</strong> con dinero disponible.<br>
          üü¢ <strong>P75</strong> es un escenario optimista: en el <strong>25% de los mejores casos</strong>, terminar√≠as con m√°s dinero.<br>
          üü† <strong>P25</strong> es un escenario conservador: en el <strong>25% de los peores escenarios</strong>, podr√≠as agotar tu fondo antes de los 100 a√±os.
        </div>
      </div>
      <canvas id="graficoMonteCarlo" width="800" height="400" style="margin-top:20px;"></canvas>
    </div>
  `;

  document.getElementById("btnTooltipExplicacionMonteCarlo").onclick = () => {
    const tooltip = document.getElementById("explicacionMonteCarlo");
    tooltip.style.display = tooltip.style.display === "none" ? "block" : "none";
  };

  const ctx = document.getElementById('graficoRetiro').getContext('2d');
  if (window.graficoRetiroInstance) window.graficoRetiroInstance.destroy();

  window.graficoRetiroInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['üß± Capital necesario', 'üíº Capital acumulado'],
      datasets: [{
        data: [necesidadFondo, montoEsperado],
        backgroundColor: ['#ef4444', '#10b981']
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      plugins: {
        legend: { display: false },
        datalabels: {
          anchor: 'end',
          align: 'right',
          formatter: value => `$${Number(value.toFixed(0)).toLocaleString()}`,
          color: '#111827',
          font: { weight: 'bold' }
        },
        tooltip: {
          callbacks: {
            label: context => `$${context.raw.toLocaleString()}`
          }
        }
      },
      scales: {
        x: {
          beginAtZero: true,
          ticks: {
            callback: value => `$${value.toLocaleString()}`
          }
        }
      }
    },
    plugins: [ChartDataLabels]
  });

  // ‚ûï Monte Carlo: generar y graficar trayectorias
  const trayectorias = generarTrayectoriasMonteCarlo(10000, anosDistribucion, montoEsperado, ingresoRequerido);
  dibujarGraficoMonteCarlo(trayectorias, edadRetiro);
}

// Generador de trayectorias de retiro Monte Carlo
function generarTrayectoriasMonteCarlo(nSimulaciones, a√±os, capitalInicial, retiroAnual, retornoMedio = 0.04, desviacion = 0.12) {
  const trayectorias = [];
  for (let i = 0; i < nSimulaciones; i++) {
    let capital = capitalInicial;
    const trayectoria = [];
    for (let j = 0; j < a√±os; j++) {
      const rendimiento = (Math.random() * desviacion * 2 - desviacion) + retornoMedio;
      capital = capital * (1 + rendimiento) - retiroAnual;
      trayectoria.push(Math.max(capital, 0));
      if (capital <= 0) break;
    }
    while (trayectoria.length < a√±os) trayectoria.push(0);
    trayectorias.push(trayectoria);
  }
  return trayectorias;
}

// Dibuja el gr√°fico tipo abanico de trayectorias
function dibujarGraficoMonteCarlo(trayectorias, edadInicio = 65) {
  const ctx = document.getElementById("graficoMonteCarlo").getContext("2d");
  const datasets = trayectorias.slice(0, 300).map(tray => ({
    data: tray.map((y, i) => ({ x: edadInicio + i, y })),
    borderColor: 'rgba(59,130,246,0.08)',
    borderWidth: 1,
    pointRadius: 0,
    fill: false,
    tension: 0.1
  }));
  new Chart(ctx, {
    type: "line",
    data: { datasets },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        x: {
          type: 'linear',
          title: { display: true, text: 'Edad' },
          ticks: { stepSize: 5 }
        },
        y: {
          title: { display: true, text: 'Capital restante ($)' },
          ticks: { callback: value => `$${value.toLocaleString()}` }
        }
      }
    }
  });
}

function calcularCategoriaH(data) {
  // üîπ Ingreso anual
  const ingresoAnual = (data.salario || 0) + (data.ingreso_negocio || 0);

  // üîπ Gastos anuales esenciales
  const gastosMensualesEsenciales = (
    (data.supermercado || 0) +
    (data.transporte || 0) +
    (data.telecomunicaciones || 0) +
    (data.servicio_publico || 0) +
    (data.seguro_medico || 0) +
    (data.seguro_propiedad || 0) +
    (data.seguro_auto || 0) +
    (data.educacion || 0) +
    (data.impuesto_federal || 0) +
    (data.impuesto_propiedad || 0) +
    (data.seguro_social || 0) +
    (data.hipoteca || 0) +
    (data.linea_credito || 0) +
    (data.prestamo_auto || 0) +
    (data.tarjetas_credito || 0) +
    (data.otros_deuda || 0)
  );

  const gastosAnuales = gastosMensualesEsenciales * 12;

  // üîπ Deuda total
  const deudaAnual = (
    (data.deuda_tarjetas || 0) +
    (data.deuda_hipotecaria || 0) +
    (data.deuda_vehiculos || 0) +
    (data.deuda_estudios || 0) +
    (data.deuda_comercial || 0) +
    (data.deuda_otros || 0) +
    (data.linea_credito || 0)
  );

  // üîπ Activos no l√≠quidos (los que se deprecian en los escenarios)
  const activosNoLiquidos = 
    (data.valor_vivienda || 0) +
    (data.valor_propiedades_alquiler || 0) +
    (data.valor_vehiculos || 0) +
    (data.valor_otros_activos || 0) +
    (data.valor_otros || 0);

  // üîπ Escenarios
  const escenarios = [
    { nombre: "Leve", ajusteIngreso: 0.90, ajusteActivo: 0.90 },
    { nombre: "Moderado", ajusteIngreso: 0.70, ajusteActivo: 0.70 },
    { nombre: "Severo", ajusteIngreso: 0.50, ajusteActivo: 0.50 }
  ];

  let tabla = `
    <h3>üÖ∑ H. Pruebas de estr√©s</h3>
    <table style="font-size: 0.95em; margin-top: 10px;">
      <thead><tr>
        <th>Escenario</th>
        <th>¬øCubre gastos?</th>
        <th>¬øCubre deudas?</th>
        <th>¬øSigue ahorrando?</th>
      </tr></thead><tbody>
  `;

  escenarios.forEach(esc => {
    const ingresoAjustado = ingresoAnual * esc.ajusteIngreso;
    const activosAjustados = activosNoLiquidos * esc.ajusteActivo;
    const ingresoTotalDisponible = ingresoAjustado + activosAjustados;

    const puedeCubrirGastos = ingresoTotalDisponible >= gastosAnuales;
    const puedeCubrirDeudas = ingresoTotalDisponible >= (gastosAnuales + deudaAnual);
    const puedeAhorrar = ingresoTotalDisponible > (gastosAnuales + deudaAnual);

    tabla += `
      <tr>
        <td>${esc.nombre}</td>
        <td>${puedeCubrirGastos ? '‚úÖ' : 'üö®'}</td>
        <td>${puedeCubrirDeudas ? '‚úÖ' : 'üö®'}</td>
        <td>${puedeAhorrar ? '‚úÖ' : (puedeCubrirDeudas ? '‚ö†Ô∏è' : 'üö®')}</td>
      </tr>
    `;
  });

  tabla += `
    </tbody></table>
    <p style="font-size: 0.9em;">
      Simulaci√≥n basada en ca√≠das del 10%, 30% y 50% en ingresos y activos no l√≠quidos.<br>
      Efectivo y equivalentes no se afectan.
    </p>
  `;

  document.getElementById("resH").innerHTML = tabla;
}

</script>
</body>
</html>

