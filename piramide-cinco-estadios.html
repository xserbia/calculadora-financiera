<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mapa de Etapas Financieras - Evaluaci√≥n Completa</title>

<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet"/>

<style>
  :root{
    --primary:#3956E8; --secondary:#7459D9; --accent:#E8C239;
    --bg:#FAFBFF; --card:#ffffff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
    --shadow:0 12px 30px rgba(15,23,42,.08); --radius:18px;
    --ok:#10b981; --warn:#f59e0b; --bad:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:"Nunito",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
  .wrap{max-width:1320px;margin:26px auto;padding:0 16px}

  /* ====== ONBOARDING MODAL ====== */
  .modal{
    position:fixed;inset:0;background:rgba(15,23,42,.90);backdrop-filter:blur(10px);
    display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px;
    opacity:0;pointer-events:none;transition:opacity .3s ease;overflow-y:auto;
  }
  .modal.show{opacity:1;pointer-events:all}
  
  .modalBox{
    background:var(--card);border-radius:24px;
    max-width:650px;width:100%;padding:32px;
    box-shadow:0 24px 60px rgba(15,23,42,.3);
    transform:scale(.95);transition:transform .3s ease;
    margin:20px auto;
  }
  .modal.show .modalBox{transform:scale(1)}

  .modalHeader{text-align:center;margin-bottom:24px}
  .modalHeader h2{font-size:28px;margin:0 0 8px;background:linear-gradient(90deg,var(--primary),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
  .modalHeader p{color:var(--muted);font-size:14px;margin:0}

  .categoryBadge{
    display:inline-flex;align-items:center;gap:8px;
    padding:6px 12px;border-radius:999px;
    background:linear-gradient(90deg,#f0f9ff,#e0f2fe);
    border:2px solid #bae6fd;
    font-weight:900;font-size:11px;
    color:#0369a1;letter-spacing:.05em;
    margin-bottom:12px;
  }

  .question{margin-bottom:24px;display:none}
  .question.active{display:block;animation:slideIn .3s ease}
  @keyframes slideIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
  @keyframes shake{
    0%, 100% {transform:translateX(0)}
    25% {transform:translateX(-8px)}
    75% {transform:translateX(8px)}
  }

  .qLabel{font-weight:900;font-size:16px;margin-bottom:12px;display:block;color:#1e293b}
  .qInput{
    width:100%;padding:14px 16px;border:2px solid var(--line);border-radius:14px;
    font-family:inherit;font-size:15px;font-weight:600;transition:.2s ease;
  }
  .qInput:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 4px rgba(57,86,232,.1)}

  .options{display:flex;gap:10px;flex-wrap:wrap}
  .optBtn{
    flex:1;min-width:140px;padding:14px 16px;border:2px solid var(--line);
    border-radius:14px;background:#fff;cursor:pointer;
    font-weight:800;font-size:13px;transition:.2s ease;text-align:center;
    line-height:1.3;
  }
  .optBtn:hover{border-color:var(--primary);background:#f0f4ff}
  .optBtn.selected{background:linear-gradient(90deg,var(--primary),var(--secondary));color:#fff;border-color:transparent}

  .optionsGrid{display:grid;grid-template-columns:1fr;gap:10px}
  .optBtnGrid{
    padding:12px 14px;border:2px solid var(--line);
    border-radius:12px;background:#fff;cursor:pointer;
    font-weight:700;font-size:13px;transition:.2s ease;
    text-align:left;
  }
  .optBtnGrid:hover{border-color:var(--primary);background:#f0f4ff}
  .optBtnGrid.selected{background:linear-gradient(90deg,var(--primary),var(--secondary));color:#fff;border-color:transparent}

  .niIdeaBtn{
    width:100%;padding:10px 16px;margin-top:8px;
    border:2px dashed var(--line);background:#fafafa;
    border-radius:12px;cursor:pointer;
    font-family:inherit;font-weight:700;font-size:13px;
    color:var(--muted);transition:.2s ease;
  }
  .niIdeaBtn:hover{
    background:#f1f5f9;border-color:var(--muted);color:#334155;
  }

  .modalFooter{display:flex;gap:12px;margin-top:28px}
  .btn{
    flex:1;padding:14px 24px;border:none;border-radius:14px;
    font-family:inherit;font-weight:900;font-size:15px;cursor:pointer;transition:.2s ease;
  }
  .btnPrimary{background:linear-gradient(90deg,var(--primary),var(--secondary));color:#fff;box-shadow:0 8px 20px rgba(57,86,232,.25)}
  .btnPrimary:hover{transform:translateY(-2px);box-shadow:0 12px 28px rgba(57,86,232,.35)}
  .btnPrimary:disabled{opacity:.5;cursor:not-allowed;transform:none}
  .btnSecondary{background:#f1f5f9;color:#334155}
  .btnSecondary:hover{background:#e2e8f0}

  .progress{
    height:8px;background:#e5e7eb;border-radius:999px;margin-bottom:20px;overflow:hidden;
  }
  .progressBar{height:100%;background:linear-gradient(90deg,var(--primary),var(--secondary));transition:width .3s ease}

  .qHelper{font-size:12px;color:var(--muted);margin-top:6px;line-height:1.4}

  /* ====== RESULTS SCREEN ====== */
  .results{display:none;text-align:center}
  .results.show{display:block;animation:fadeIn .5s ease}
  @keyframes fadeIn{from{opacity:0}to{opacity:1}}

  .bigBadge{
    display:inline-flex;align-items:center;gap:12px;
    padding:18px 32px;border-radius:999px;
    background:linear-gradient(90deg,var(--primary),var(--secondary));
    color:#fff;font-weight:900;font-size:22px;margin-bottom:16px;
    box-shadow:0 12px 32px rgba(57,86,232,.3);
  }
  .bigIcon{font-size:36px}

  .resultScore{
    font-size:80px;font-weight:900;
    background:linear-gradient(90deg,var(--primary),var(--secondary));
    -webkit-background-clip:text;-webkit-text-fill-color:transparent;
    background-clip:text;margin:12px 0;line-height:1;
  }

  .resultText{font-size:18px;color:var(--muted);margin-bottom:32px}

  .categoryScores{
    display:grid;grid-template-columns:repeat(2,1fr);gap:12px;
    margin:24px 0;text-align:left;
  }
  .catScore{
    background:#f8fafc;border:1px solid var(--line);
    border-radius:12px;padding:12px;
  }
  .catScoreTitle{font-size:11px;font-weight:900;color:#64748b;text-transform:uppercase;letter-spacing:.05em}
  .catScoreBar{
    height:6px;background:#e5e7eb;border-radius:999px;margin:6px 0 4px;overflow:hidden;
  }
  .catScoreFill{height:100%;background:var(--primary);transition:width .4s ease}
  .catScoreVal{font-size:12px;font-weight:800;color:#0f172a}

  /* ====== MAIN LAYOUT ====== */
  .top{
    display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;
    margin-bottom:14px;
  }
  h1{font-size:26px;margin:0}
  .sub{margin:6px 0 0;color:var(--muted);font-size:13px}

  .stagePicker{
    display:flex;gap:8px;flex-wrap:wrap;align-items:center;
    background:var(--card);border:1px solid var(--line);
    padding:10px;border-radius:14px;box-shadow:var(--shadow);
  }
  .stageBtn{
    border:1px solid var(--line);background:#fff;color:#111827;
    padding:8px 10px;border-radius:12px;cursor:pointer;font-weight:800;font-size:12px;
    transition:.16s ease;
  }
  .stageBtn.active{
    background:linear-gradient(90deg,var(--primary),var(--secondary));
    color:#fff;border-color:transparent;
  }

  .grid{
    display:grid;
    grid-template-columns: 340px 1fr 340px;
    gap:14px;
    align-items:start;
  }
  @media (max-width: 1180px){
    .grid{grid-template-columns: 340px 1fr}
    .actionPanel{display:none}
  }
  @media (max-width: 980px){
    .grid{grid-template-columns:1fr}
  }

  .card{
    background:var(--card);border:1px solid var(--line);
    border-radius:var(--radius);box-shadow:var(--shadow);
    padding:16px;
  }

  /* ====== PYRAMID ====== */
  .pyrWrap{position:sticky; top:14px}
  @media (max-width: 980px){
    .pyrWrap{position:relative; top:auto}
  }

  .pyrHead{
    display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
    margin-bottom:10px;
  }
  .pill{
    display:inline-flex;align-items:center;gap:8px;
    padding:6px 10px;border-radius:999px;
    border:1px solid var(--line);background:#f5f7ff;
    font-weight:900;font-size:12px;
  }
  .dot{width:10px;height:10px;border-radius:999px;background:var(--primary)}
  .pyrSub{color:var(--muted);font-size:12px;margin:0}

  .pyramid{
    --w: 280px;
    width: min(var(--w), 100%);
    margin: 12px auto 6px;
    display:flex;
    flex-direction:column;
    gap:10px;
    padding-bottom:6px;
  }

  .pstep{
    position:relative;
    height:62px;
    margin:0 auto;
    border-radius:16px;
    border:1px solid var(--line);
    background:#f8fafc;
    overflow:hidden;
    box-shadow: 0 8px 18px rgba(15,23,42,.06);
    transition: transform .16s ease, box-shadow .16s ease, filter .16s ease, opacity .16s ease;
    opacity:.55;
    filter:saturate(.7);
    cursor:pointer;
  }
  .pstep:hover{transform:translateY(-2px);box-shadow:0 12px 24px rgba(15,23,42,.12)}
  
  .pstep::before{
    content:"";
    position:absolute;inset:0;
    background:linear-gradient(90deg, rgba(57,86,232,.10), rgba(116,89,217,.10));
    opacity:0;
    transition:.16s ease;
  }

  .pProgressBg{
    position:absolute;left:0;top:0;bottom:0;
    background:linear-gradient(90deg, rgba(16,185,129,.15), rgba(16,185,129,.25));
    width:0%;
    transition:width .4s ease;
  }

  .pstep.s5{width:54%}
  .pstep.s4{width:66%}
  .pstep.s3{width:78%}
  .pstep.s2{width:90%}
  .pstep.s1{width:100%}

  .pinner{
    height:100%;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding:12px 12px;
    position:relative;
    z-index:1;
  }
  .ptitle{
    display:flex;flex-direction:column;gap:2px;
    line-height:1.15;
  }
  .ptitle b{font-size:12px}
  .ptitle span{font-size:11px;color:#475569;font-weight:800;letter-spacing:.04em;text-transform:uppercase}
  .pnum{
    width:28px;height:28px;border-radius:12px;
    background:#EEF3FF;border:1px solid #D8E0FF;
    display:flex;align-items:center;justify-content:center;
    font-weight:900;color:#1e293b;font-size:12px;
    flex:0 0 auto;
  }

  .pPercent{
    position:absolute;top:4px;right:6px;
    font-size:10px;font-weight:900;
    background:rgba(255,255,255,.9);
    padding:2px 6px;border-radius:6px;
    color:var(--ok);
    opacity:0;
    transition:opacity .2s ease;
  }
  .pstep.done .pPercent,
  .pstep.active .pPercent{opacity:1}

  .pstep.done{opacity:.85;filter:saturate(1)}
  .pstep.active{
    opacity:1;filter:saturate(1.05);
    transform: translateY(-1px);
    border-color: rgba(57,86,232,.35);
    box-shadow: 0 12px 26px rgba(57,86,232,.16);
  }
  .pstep.active::before{opacity:1}
  .pstep.active .pnum{
    background:linear-gradient(90deg,var(--primary),var(--secondary));
    border-color:transparent;color:#fff;
  }

  .pLegend{
    display:flex;gap:8px;flex-wrap:wrap;justify-content:center;
    margin-top:8px;
  }
  .lg{
    font-size:11px;font-weight:900;color:#334155;
    display:inline-flex;align-items:center;gap:6px;
    border:1px solid var(--line);border-radius:999px;background:#fff;padding:5px 8px;
  }
  .lg i{width:10px;height:10px;border-radius:999px;display:inline-block}
  .lg .iDone{background:#a7f3d0}
  .lg .iAct{background:#c7d2fe}
  .lg .iOff{background:#e5e7eb}

  /* ====== CONTENT ====== */
  .headerCard{
    display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;
  }
  .stageTitle{font-size:18px;font-weight:900;margin:0 0 4px}
  .stageMini{color:var(--muted);font-size:13px;margin:0}

  .blockTitle{
    font-size:12px;letter-spacing:.08em;text-transform:uppercase;
    color:#334155;font-weight:900;margin:0 0 8px;
    display:flex;align-items:center;gap:8px;
  }
  .blockTitle::before{
    content:"";width:10px;height:10px;border-radius:3px;background:var(--accent);
  }

  .bigQuote{
    border:1px dashed var(--line);
    background:#F7F8FE;
    padding:12px;border-radius:14px;
    font-size:14px;line-height:1.5;color:#0f172a;
  }

  .list{margin:0;padding:0;list-style:none}
  .list li{
    display:flex;gap:10px;align-items:flex-start;
    padding:10px;border:1px solid var(--line);
    border-radius:14px;background:#fff;margin-bottom:10px;
  }
  .badge{
    flex:0 0 auto;
    display:inline-flex;align-items:center;justify-content:center;
    width:26px;height:26px;border-radius:10px;
    background:#EEF3FF;border:1px solid #D8E0FF;color:#1e293b;font-weight:900;
  }
  .liTitle{font-weight:900}
  .liText{color:#334155;font-size:13px;margin-top:2px;line-height:1.35}

  .metricGrid{
    display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;
  }
  @media (max-width: 520px){
    .metricGrid{grid-template-columns:1fr}
  }
  .metric{
    border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff;
  }
  .metricTop{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:4px}
  .metricName{font-weight:900;font-size:13px}
  .metricIcon{font-size:18px}
  .metricVal{font-size:20px;font-weight:900;color:var(--primary);margin:4px 0}
  .metricDesc{font-size:11px;color:var(--muted)}

  /* ====== ACTION PANEL ====== */
  .actionPanel{position:sticky;top:14px}
  
  .apHeader{
    background:linear-gradient(135deg,var(--primary),var(--secondary));
    color:#fff;padding:16px;border-radius:var(--radius) var(--radius) 0 0;
    margin:-16px -16px 16px;
  }
  .apHeader h3{margin:0;font-size:18px;display:flex;align-items:center;gap:8px}
  .apHeader p{margin:6px 0 0;font-size:12px;opacity:.9}

  .nextGoal{
    background:#f0f9ff;border:2px solid #bae6fd;
    border-radius:14px;padding:14px;margin-bottom:14px;
  }
  .goalTitle{font-weight:900;font-size:14px;margin:0 0 10px;color:#0c4a6e}
  
  .progressTrack{
    background:#e0f2fe;border-radius:999px;height:10px;overflow:hidden;margin-bottom:8px;
  }
  .progressFill{
    background:linear-gradient(90deg,#0ea5e9,#06b6d4);
    height:100%;border-radius:999px;transition:width .4s ease;
  }
  
  .goalStats{display:flex;justify-content:space-between;font-size:12px;font-weight:800;color:#0369a1}

  .steps{margin-top:16px}
  .steps h4{font-size:13px;font-weight:900;margin:0 0 10px;color:#1e293b}
  .steps ul{margin:0;padding:0;list-style:none}
  .steps li{
    padding:10px;background:#fff;border:1px solid var(--line);
    border-radius:12px;margin-bottom:8px;font-size:13px;
    display:flex;align-items:flex-start;gap:8px;
  }
  .steps li::before{
    content:"‚Üí";font-weight:900;color:var(--primary);flex:0 0 auto;
  }

  .weakAreas{
    background:#fef3c7;border:2px solid #fde047;
    border-radius:14px;padding:14px;margin-top:14px;
  }
  .weakAreas h4{margin:0 0 10px;font-size:13px;font-weight:900;color:#854d0e;display:flex;align-items:center;gap:6px}
  .weakAreas ul{margin:0;padding:0;list-style:none}
  .weakAreas li{
    font-size:12px;padding:6px 0;color:#713f12;font-weight:700;
    display:flex;align-items:center;gap:8px;
  }
  .weakAreas li::before{content:"‚ö†Ô∏è";flex:0 0 auto}

  .retakeBtn{
    width:100%;margin-top:14px;padding:12px;
    background:#f1f5f9;border:1px solid var(--line);
    border-radius:12px;font-weight:900;cursor:pointer;
    transition:.2s ease;
  }
  .retakeBtn:hover{background:#e2e8f0}
</style>
</head>

<body>
  <!-- ====== ONBOARDING MODAL ====== -->
  <div class="modal show" id="modal">
    <div class="modalBox">
      <div class="modalHeader">
        <h2>üéØ Evaluaci√≥n Financiera Completa</h2>
        <p>13 preguntas para determinar tu etapa con precisi√≥n</p>
      </div>

      <div class="progress">
        <div class="progressBar" id="progressBar" style="width:0%"></div>
      </div>

      <!-- ===== CATEGOR√çA A: FLUJO DE CAJA ===== -->
      <div class="question active" data-q="1" data-cat="flujo">
        <div class="categoryBadge">üìä A. FLUJO DE CAJA</div>
        <label class="qLabel">1. ¬øTu ingreso mensual cubre todos tus gastos sin usar cr√©dito?</label>
        <div class="options">
          <button class="optBtn" data-value="no">No, uso cr√©dito</button>
          <button class="optBtn" data-value="justo">S√≠, justo</button>
          <button class="optBtn" data-value="sobra">S√≠, me sobra</button>
        </div>
      </div>

      <div class="question" data-q="2" data-cat="flujo">
        <div class="categoryBadge">üìä A. FLUJO DE CAJA</div>
        <label class="qLabel">2. ¬øQu√© % de tu ingreso queda libre despu√©s de pagar todo?</label>
        <input type="number" class="qInput" id="q2" placeholder="Ej: 15" min="0" max="100" step="1">
        <div class="qHelper">Incluye gastos fijos, variables y deudas. Si gastas m√°s de lo que ganas, pon 0.</div>
        <button class="niIdeaBtn" data-default="5">ü§∑ Ni idea (usaremos 5%)</button>
      </div>

      <div class="question" data-q="3" data-cat="flujo">
        <div class="categoryBadge">üìä A. FLUJO DE CAJA</div>
        <label class="qLabel">3. ¬øCu√°ntos meses de gastos esenciales tienes ahorrados?</label>
        <input type="number" class="qInput" id="q3" placeholder="Ej: 6" min="0" max="60" step="0.5">
        <div class="qHelper">Reserva de emergencia en efectivo/cuenta corriente.</div>
        <button class="niIdeaBtn" data-default="0">ü§∑ Ni idea (usaremos 0)</button>
      </div>

      <!-- ===== CATEGOR√çA B: DEUDA ===== -->
      <div class="question" data-q="4" data-cat="deuda">
        <div class="categoryBadge">üí≥ B. DEUDA</div>
        <label class="qLabel">4. ¬øQu√© % de tu ingreso va a pagar deudas mensuales?</label>
        <input type="number" class="qInput" id="q4" placeholder="Ej: 35" min="0" max="100" step="1">
        <div class="qHelper">Incluye: tarjetas, pr√©stamos, hipoteca, auto. Todo pago de deuda.</div>
        <button class="niIdeaBtn" data-default="30">ü§∑ Ni idea (usaremos 30%)</button>
      </div>

      <div class="question" data-q="5" data-cat="deuda">
        <div class="categoryBadge">üí≥ B. DEUDA</div>
        <label class="qLabel">5. ¬øTienes deudas de consumo (tarjetas/pr√©stamos personales)?</label>
        <div class="options">
          <button class="optBtn" data-value="mucha">S√≠, bastante</button>
          <button class="optBtn" data-value="poca">S√≠, poca</button>
          <button class="optBtn" data-value="solo-hipoteca">Solo hipoteca</button>
          <button class="optBtn" data-value="no">No tengo</button>
        </div>
      </div>

      <!-- ===== CATEGOR√çA C: AHORRO E INVERSI√ìN ===== -->
      <div class="question" data-q="6" data-cat="ahorro">
        <div class="categoryBadge">üí∞ C. AHORRO E INVERSI√ìN</div>
        <label class="qLabel">6. ¬øQu√© % de tu ingreso ahorras/inviertes mensualmente?</label>
        <input type="number" class="qInput" id="q6" placeholder="Ej: 20" min="0" max="100" step="1">
        <div class="qHelper">Incluye ahorros, inversiones, retiro, fondos. Todo lo que guardas.</div>
        <button class="niIdeaBtn" data-default="5">ü§∑ Ni idea (usaremos 5%)</button>
      </div>

      <div class="question" data-q="7" data-cat="ahorro">
        <div class="categoryBadge">üí∞ C. AHORRO E INVERSI√ìN</div>
        <label class="qLabel">7. ¬øCu√°nto tienes acumulado para el retiro vs tu ingreso anual?</label>
        <div class="optionsGrid">
          <button class="optBtnGrid" data-value="0">Nada o casi nada (0√ó)</button>
          <button class="optBtnGrid" data-value="1">Menos de 1 a√±o de ingreso (0-1√ó)</button>
          <button class="optBtnGrid" data-value="3">1 a 3 a√±os de ingreso (1-3√ó)</button>
          <button class="optBtnGrid" data-value="5">3 a 5 a√±os de ingreso (3-5√ó)</button>
          <button class="optBtnGrid" data-value="10">5 a 10 a√±os de ingreso (5-10√ó)</button>
          <button class="optBtnGrid" data-value="15">M√°s de 10 a√±os de ingreso (10√ó+)</button>
        </div>
      </div>

      <div class="question" data-q="8" data-cat="ahorro">
        <div class="categoryBadge">üí∞ C. AHORRO E INVERSI√ìN</div>
        <label class="qLabel">8. ¬øTu patrimonio neto (activos - deudas) vs tu ingreso anual?</label>
        <div class="optionsGrid">
          <button class="optBtnGrid" data-value="-1">Negativo (debo m√°s de lo que tengo)</button>
          <button class="optBtnGrid" data-value="0.5">0 a 1 a√±o de ingreso (0-1√ó)</button>
          <button class="optBtnGrid" data-value="2">1 a 3 a√±os de ingreso (1-3√ó)</button>
          <button class="optBtnGrid" data-value="6">3 a 10 a√±os de ingreso (3-10√ó)</button>
          <button class="optBtnGrid" data-value="15">10 a 25 a√±os de ingreso (10-25√ó)</button>
          <button class="optBtnGrid" data-value="30">M√°s de 25 a√±os de ingreso (25√ó+)</button>
        </div>
        <div class="qHelper">Patrimonio neto = Todo lo que tienes - Todo lo que debes</div>
      </div>

      <!-- ===== CATEGOR√çA D: INGRESOS PASIVOS ===== -->
      <div class="question" data-q="9" data-cat="pasivo">
        <div class="categoryBadge">üìà D. INGRESOS PASIVOS</div>
        <label class="qLabel">9. ¬øTienes ingresos pasivos (inversiones, rentas, dividendos)?</label>
        <div class="options">
          <button class="optBtn" data-value="no">No tengo</button>
          <button class="optBtn" data-value="minimos">S√≠, m√≠nimos</button>
          <button class="optBtn" data-value="moderados">S√≠, moderados</button>
          <button class="optBtn" data-value="significativos">S√≠, significativos</button>
        </div>
      </div>

      <div class="question" data-q="10" data-cat="pasivo">
        <div class="categoryBadge">üìà D. INGRESOS PASIVOS</div>
        <label class="qLabel">10. ¬øQu√© % de tus gastos anuales cubren tus ingresos pasivos?</label>
        <div class="options">
          <button class="optBtn" data-value="0">0% (no tengo)</button>
          <button class="optBtn" data-value="10">~10-25%</button>
          <button class="optBtn" data-value="40">~25-50%</button>
          <button class="optBtn" data-value="65">~50-75%</button>
          <button class="optBtn" data-value="90">~75-100%</button>
          <button class="optBtn" data-value="120">+100%</button>
        </div>
      </div>

      <!-- ===== CATEGOR√çA E: SEGUROS Y PROTECCI√ìN ===== -->
      <div class="question" data-q="11" data-cat="proteccion">
        <div class="categoryBadge">üõ°Ô∏è E. SEGUROS Y PROTECCI√ìN</div>
        <label class="qLabel">11. ¬øQu√© seguros tienes actualmente?</label>
        <div class="optionsGrid">
          <button class="optBtnGrid" data-value="0">Ninguno o solo b√°sico obligatorio</button>
          <button class="optBtnGrid" data-value="1">Salud + Auto</button>
          <button class="optBtnGrid" data-value="2">Lo anterior + Vida</button>
          <button class="optBtnGrid" data-value="3">Lo anterior + Discapacidad/Incapacidad</button>
          <button class="optBtnGrid" data-value="4">Cobertura completa + Umbrella/Responsabilidad</button>
        </div>
      </div>

      <div class="question" data-q="12" data-cat="proteccion">
        <div class="categoryBadge">üõ°Ô∏è E. SEGUROS Y PROTECCI√ìN</div>
        <label class="qLabel">12. ¬øTienes documentos de planificaci√≥n patrimonial?</label>
        <div class="optionsGrid">
          <button class="optBtnGrid" data-value="0">Ninguno</button>
          <button class="optBtnGrid" data-value="1">Testamento b√°sico</button>
          <button class="optBtnGrid" data-value="2">Testamento + POA + Beneficiarios actualizados</button>
          <button class="optBtnGrid" data-value="3">Lo anterior + Trusts o estructuras patrimoniales</button>
        </div>
      </div>

      <!-- ===== CATEGOR√çA F: CONTROL ===== -->
      <div class="question" data-q="13" data-cat="control">
        <div class="categoryBadge">üìã F. CONTROL Y H√ÅBITOS</div>
        <label class="qLabel">13. ¬øCon qu√© frecuencia revisas y controlas tus finanzas?</label>
        <div class="optionsGrid">
          <button class="optBtnGrid" data-value="0">Nunca o casi nunca</button>
          <button class="optBtnGrid" data-value="1">Solo cuando hay problemas</button>
          <button class="optBtnGrid" data-value="2">Mensualmente reviso gastos</button>
          <button class="optBtnGrid" data-value="3">Semanalmente + plan anual</button>
        </div>
      </div>

      <!-- ===== RESULTS ===== -->
      <div class="results" id="results">
        <div class="bigBadge">
          <span class="bigIcon" id="resultIcon">üÜò</span>
          <span id="resultStage">ETAPA 1</span>
        </div>
        <div class="resultScore" id="resultPercent">0%</div>
        <p class="resultText">Completado en esta etapa</p>

        <div class="categoryScores" id="categoryScores"></div>
      </div>

      <div class="modalFooter">
        <button class="btn btnSecondary" id="btnBack" style="display:none">‚Üê Atr√°s</button>
        <button class="btn btnPrimary" id="btnNext">Siguiente ‚Üí</button>
      </div>
    </div>
  </div>

  <!-- ====== MAIN APP ====== -->
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Mapa de Etapas Financieras</h1>
        <p class="sub">Tu ruta personalizada basada en evaluaci√≥n completa</p>
      </div>

      <div class="stagePicker" role="group" aria-label="Selector de etapa">
        <button class="stageBtn active" data-stage="1">Etapa 1</button>
        <button class="stageBtn" data-stage="2">Etapa 2</button>
        <button class="stageBtn" data-stage="3">Etapa 3</button>
        <button class="stageBtn" data-stage="4">Etapa 4</button>
        <button class="stageBtn" data-stage="5">Etapa 5</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: PYRAMID -->
      <div class="card pyrWrap">
        <div class="pyrHead">
          <div class="pill"><span class="dot" id="stageDot"></span><span id="stagePill">ETAPA 1 ¬∑ SUPERVIVENCIA</span></div>
        </div>
        <p class="pyrSub">Tu progreso de base (Supervivencia) hacia la cima (Libertad).</p>

        <div class="pyramid">
          <div class="pstep s5" data-step="5">
            <div class="pProgressBg" data-progress="5"></div>
            <div class="pPercent" data-percent="5">0%</div>
            <div class="pinner">
              <div class="ptitle"><b>üü¶ Libertad</b><span>Etapa 5</span></div>
              <div class="pnum">5</div>
            </div>
          </div>
          <div class="pstep s4" data-step="4">
            <div class="pProgressBg" data-progress="4"></div>
            <div class="pPercent" data-percent="4">0%</div>
            <div class="pinner">
              <div class="ptitle"><b>üü© Independencia</b><span>Etapa 4</span></div>
              <div class="pnum">4</div>
            </div>
          </div>
          <div class="pstep s3" data-step="3">
            <div class="pProgressBg" data-progress="3"></div>
            <div class="pPercent" data-percent="3">0%</div>
            <div class="pinner">
              <div class="ptitle"><b>üí∞ Acumulaci√≥n</b><span>Etapa 3</span></div>
              <div class="pnum">3</div>
            </div>
          </div>
          <div class="pstep s2" data-step="2">
            <div class="pProgressBg" data-progress="2"></div>
            <div class="pPercent" data-percent="2">0%</div>
            <div class="pinner">
              <div class="ptitle"><b>üõ°Ô∏è Seguridad</b><span>Etapa 2</span></div>
              <div class="pnum">2</div>
            </div>
          </div>
          <div class="pstep s1" data-step="1">
            <div class="pProgressBg" data-progress="1"></div>
            <div class="pPercent" data-percent="1">0%</div>
            <div class="pinner">
              <div class="ptitle"><b>üÜò Supervivencia</b><span>Etapa 1</span></div>
              <div class="pnum">1</div>
            </div>
          </div>
        </div>

        <div class="pLegend">
          <span class="lg"><i class="iOff"></i>Inactivo</span>
          <span class="lg"><i class="iDone"></i>Completado</span>
          <span class="lg"><i class="iAct"></i>Actual</span>
        </div>
      </div>

      <!-- CENTER: DETAILS -->
      <div class="card">
        <div class="headerCard">
          <div>
            <h2 class="stageTitle" id="stageTitle">üÜò Supervivencia</h2>
            <p class="stageMini" id="stageMini">Estabilizar flujo y eliminar dependencia de cr√©dito.</p>
          </div>
        </div>

        <div style="margin-top:14px">
          <div class="blockTitle">Criterios de la etapa</div>
          <div id="criteria"></div>
        </div>

        <div style="margin-top:14px">
          <div class="blockTitle">Tus m√©tricas actuales</div>
          <div class="metricGrid" id="userMetrics"></div>
        </div>

        <div style="margin-top:14px">
          <div class="blockTitle">Requisitos para avanzar</div>
          <ul class="list" id="requirements"></ul>
        </div>
      </div>

      <!-- RIGHT: ACTION PANEL -->
      <div class="card actionPanel">
        <div class="apHeader">
          <h3>üéØ Tu Plan de Acci√≥n</h3>
          <p>Prioridades para avanzar</p>
        </div>

        <div class="nextGoal">
          <div class="goalTitle" id="nextGoalTitle">Meta principal</div>
          <div class="progressTrack">
            <div class="progressFill" id="nextGoalProgress" style="width:0%"></div>
          </div>
          <div class="goalStats">
            <span id="nextGoalCurrent">Actual</span>
            <span id="nextGoalTarget">Meta</span>
          </div>
        </div>

        <div class="steps">
          <h4>üìã Pasos Recomendados</h4>
          <ul id="actionSteps"></ul>
        </div>

        <div class="weakAreas" id="weakAreasBox">
          <h4>‚ö†Ô∏è √Åreas de Mejora</h4>
          <ul id="weakAreasList"></ul>
        </div>

        <button class="retakeBtn" onclick="retakeQuiz()">üîÑ Recalcular Evaluaci√≥n</button>
      </div>
    </div>
  </div>

<script>
  // ===== STAGE DEFINITIONS =====
  const STAGES = {
    1: {
      pill: "ETAPA 1 ¬∑ SUPERVIVENCIA",
      title: "üÜò Supervivencia",
      icon: "üÜò",
      mini: "Estabilizar flujo y eliminar dependencia de cr√©dito.",
      criteria: [
        "Cash flow ratio < 1.05 o usa cr√©dito para gastos b√°sicos",
        "Reserva de emergencia: 0-1 mes",
        "DTI (deuda/ingreso): > 40%",
        "Sin seguros b√°sicos o planificaci√≥n",
        "Patrimonio neto ‚â§ 1√ó ingreso anual"
      ],
      requirements: [
        {t:"Alcanzar cash flow positivo", d:"Ingresos > gastos sin usar cr√©dito"},
        {t:"Construir reserva de 1 mes", d:"Primer colch√≥n de emergencia"},
        {t:"Reducir DTI a 40% o menos", d:"Servicio de deuda manejable"},
        {t:"Establecer control mensual", d:"Tracking b√°sico de finanzas"}
      ]
    },
    2: {
      pill: "ETAPA 2 ¬∑ SEGURIDAD",
      title: "üõ°Ô∏è Seguridad",
      icon: "üõ°Ô∏è",
      mini: "Construir estabilidad y protecci√≥n ante imprevistos.",
      criteria: [
        "Cash flow positivo consistente (1.05-1.20√ó)",
        "Reserva: 3-9 meses de gastos",
        "DTI: 30-40%",
        "Seguros b√°sicos (salud, vida)",
        "Patrimonio neto: 1-5√ó ingreso anual"
      ],
      requirements: [
        {t:"Elevar reserva a 9-12 meses", d:"Estabilidad financiera robusta"},
        {t:"Reducir DTI bajo 30%", d:"Deuda en niveles saludables"},
        {t:"Ahorro ‚â• 15% mensual", d:"Comenzar acumulaci√≥n activa"},
        {t:"Seguros completos", d:"Protecci√≥n vida + discapacidad"}
      ]
    },
    3: {
      pill: "ETAPA 3 ¬∑ ACUMULACI√ìN",
      title: "üí∞ Acumulaci√≥n",
      icon: "üí∞",
      mini: "Crecer patrimonio de manera consistente.",
      criteria: [
        "Cash flow: ‚â• 1.20√ó",
        "Reserva: 12+ meses",
        "DTI: < 30%",
        "Tasa de ahorro: 15-30%",
        "Patrimonio neto: 5-15√ó ingreso anual",
        "Retiro: 3-10√ó ingreso anual acumulado"
      ],
      requirements: [
        {t:"Patrimonio ‚â• 15√ó ingreso", d:"Base s√≥lida para independencia"},
        {t:"Ingresos pasivos iniciales", d:"Comenzar a generar flujo pasivo"},
        {t:"Ahorro ‚â• 25%", d:"Acelerar acumulaci√≥n"},
        {t:"Retiro ‚â• 10√ó ingreso", d:"Camino a independencia financiera"}
      ]
    },
    4: {
      pill: "ETAPA 4 ¬∑ INDEPENDENCIA",
      title: "üü© Independencia",
      icon: "üü©",
      mini: "Ingresos pasivos sostienen tu estilo de vida.",
      criteria: [
        "Patrimonio neto: 15-30√ó ingreso anual",
        "Ingresos pasivos: 50-100% de gastos",
        "DTI: < 20%",
        "SWR (tasa retiro): ‚â§ 4%",
        "Estate planning b√°sico completo"
      ],
      requirements: [
        {t:"Ingresos pasivos ‚â• gastos", d:"Libertad financiera total"},
        {t:"Patrimonio ‚â• 30√ó gastos", d:"Sostenibilidad a largo plazo"},
        {t:"Estate planning avanzado", d:"Trusts y estructuras"},
        {t:"Eliminar deuda consumo", d:"DTI < 10%"}
      ]
    },
    5: {
      pill: "ETAPA 5 ¬∑ LIBERTAD",
      title: "üü¶ Libertad",
      icon: "üü¶",
      mini: "Riqueza, legado y libertad completa.",
      criteria: [
        "Patrimonio neto: 30√ó+ gastos anuales",
        "Ingresos pasivos: 120%+ de gastos",
        "DTI: < 10% o sin deuda",
        "SWR: ‚â§ 3%",
        "Estate planning completo (trusts, sucesi√≥n)",
        "Impacto generacional estructurado"
      ],
      requirements: [
        {t:"Mantener y proteger", d:"Preservaci√≥n de riqueza"},
        {t:"Optimizaci√≥n fiscal", d:"Estructuras eficientes"},
        {t:"Legado multigeneracional", d:"Transferencia planificada"},
        {t:"Filantrop√≠a estrat√©gica", d:"Impacto social estructurado"}
      ]
    }
  };

  // ===== QUIZ LOGIC =====
  let currentQ = 1;
  const totalQ = 13;
  let answers = {};
  let userStage = 1;
  let userPercent = 0;
  let stageProgress = {1:0, 2:0, 3:0, 4:0, 5:0};
  let categoryScores = {flujo:0, deuda:0, ahorro:0, pasivo:0, proteccion:0, control:0};
  let userMetrics = {};

  const modal = document.getElementById('modal');
  const progressBar = document.getElementById('progressBar');
  const btnNext = document.getElementById('btnNext');
  const btnBack = document.getElementById('btnBack');
  const results = document.getElementById('results');
  
  function updateProgress(){
    const percent = ((currentQ-1) / totalQ) * 100;
    progressBar.style.width = percent + '%';
  }

  function showQuestion(n){
    document.querySelectorAll('.question').forEach(q => q.classList.remove('active'));
    const q = document.querySelector(`.question[data-q="${n}"]`);
    if(q) q.classList.add('active');
    
    btnBack.style.display = n > 1 ? 'block' : 'none';
    btnNext.textContent = n === totalQ ? 'Ver Resultado ‚Üí' : 'Siguiente ‚Üí';
    
    updateProgress();
  }

  btnNext.addEventListener('click', ()=>{
    if(currentQ <= totalQ){
      const q = document.querySelector(`.question[data-q="${currentQ}"]`);
      const input = q.querySelector('input.qInput');
      const selected = q.querySelector('.optBtn.selected, .optBtnGrid.selected');
      
      if(input){
        const val = input.value.trim();
        if(val === '' || val === null || isNaN(parseFloat(val))){
          input.style.borderColor = 'var(--bad)';
          input.style.boxShadow = '0 0 0 4px rgba(239,68,68,.2)';
          input.focus();
          setTimeout(()=> {
            input.style.borderColor = '';
            input.style.boxShadow = '';
          }, 2000);
          return;
        }
        answers[`q${currentQ}`] = parseFloat(val);
      } else if(selected){
        answers[`q${currentQ}`] = selected.dataset.value;
      } else {
        const opts = q.querySelectorAll('.optBtn, .optBtnGrid');
        opts.forEach(opt => {
          opt.style.borderColor = 'var(--bad)';
          opt.style.animation = 'shake 0.5s';
        });
        setTimeout(()=> {
          opts.forEach(opt => {
            opt.style.borderColor = '';
            opt.style.animation = '';
          });
        }, 1000);
        return;
      }
      
      if(currentQ === totalQ){
        calculateStage();
        showResults();
      } else {
        currentQ++;
        showQuestion(currentQ);
      }
    }
  });

  btnBack.addEventListener('click', ()=>{
    if(currentQ > 1){
      currentQ--;
      showQuestion(currentQ);
    }
  });

  document.querySelectorAll('.optBtn, .optBtnGrid').forEach(btn => {
    btn.addEventListener('click', ()=>{
      btn.parentElement.querySelectorAll('.optBtn, .optBtnGrid').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
    });
  });

  document.querySelectorAll('.niIdeaBtn').forEach(btn => {
    btn.addEventListener('click', (e)=>{
      e.preventDefault();
      const defaultVal = btn.dataset.default;
      const question = btn.closest('.question');
      const input = question.querySelector('.qInput');
      
      if(input){
        input.value = defaultVal;
        input.style.borderColor = 'var(--ok)';
        input.style.boxShadow = '0 0 0 4px rgba(16,185,129,.1)';
        setTimeout(()=>{
          input.style.borderColor = '';
          input.style.boxShadow = '';
        }, 1000);
      }
    });
  });

  document.querySelectorAll('.qInput').forEach(input => {
    input.addEventListener('keypress', (e)=>{
      if(e.key === 'Enter'){
        e.preventDefault();
        btnNext.click();
      }
    });
  });

  function calculateStage(){
    // Parse answers into metrics
    const cashFlowStatus = answers.q1; // "no", "justo", "sobra"
    const freeIncome = parseFloat(answers.q2) || 0;
    const reserva = parseFloat(answers.q3) || 0;
    const dti = parseFloat(answers.q4) || 0;
    const deudaConsumo = answers.q5; // "mucha", "poca", "solo-hipoteca", "no"
    const tasaAhorro = parseFloat(answers.q6) || 0;
    const retiroAcumulado = parseFloat(answers.q7) || 0;
    const patrimonioNeto = parseFloat(answers.q8) || -1;
    const tienePasivos = answers.q9; // "no", "minimos", "moderados", "significativos"
    const pasivoCoberturaGasto = parseFloat(answers.q10) || 0;
    const seguros = parseFloat(answers.q11) || 0;
    const estatePlanning = parseFloat(answers.q12) || 0;
    const control = parseFloat(answers.q13) || 0;

    // Store user metrics
    userMetrics = {
      cashFlow: cashFlowStatus === 'sobra' ? 1.15 : cashFlowStatus === 'justo' ? 1.0 : 0.9,
      freeIncome,
      reserva,
      dti,
      deudaConsumo,
      tasaAhorro,
      retiroAcumulado,
      patrimonioNeto,
      pasivoCoberturaGasto,
      seguros,
      estatePlanning,
      control
    };

    // Category scoring
    categoryScores.flujo = Math.min(100, (
      (cashFlowStatus === 'sobra' ? 40 : cashFlowStatus === 'justo' ? 20 : 0) +
      (freeIncome >= 20 ? 30 : freeIncome >= 10 ? 20 : freeIncome >= 5 ? 10 : 0) +
      (reserva >= 12 ? 30 : reserva >= 6 ? 20 : reserva >= 3 ? 10 : reserva >= 1 ? 5 : 0)
    ));

    categoryScores.deuda = Math.min(100, (
      (dti <= 20 ? 50 : dti <= 30 ? 40 : dti <= 40 ? 25 : dti <= 50 ? 10 : 0) +
      (deudaConsumo === 'no' ? 50 : deudaConsumo === 'solo-hipoteca' ? 40 : deudaConsumo === 'poca' ? 20 : 5)
    ));

    categoryScores.ahorro = Math.min(100, (
      (tasaAhorro >= 30 ? 40 : tasaAhorro >= 20 ? 30 : tasaAhorro >= 15 ? 20 : tasaAhorro >= 10 ? 10 : tasaAhorro >= 5 ? 5 : 0) +
      (retiroAcumulado >= 15 ? 30 : retiroAcumulado >= 10 ? 25 : retiroAcumulado >= 5 ? 15 : retiroAcumulado >= 3 ? 10 : retiroAcumulado >= 1 ? 5 : 0) +
      (patrimonioNeto >= 30 ? 30 : patrimonioNeto >= 15 ? 25 : patrimonioNeto >= 6 ? 15 : patrimonioNeto >= 2 ? 10 : patrimonioNeto >= 0.5 ? 5 : 0)
    ));

    categoryScores.pasivo = Math.min(100, (
      (pasivoCoberturaGasto >= 100 ? 100 : pasivoCoberturaGasto >= 75 ? 75 : pasivoCoberturaGasto >= 50 ? 50 : pasivoCoberturaGasto >= 25 ? 25 : pasivoCoberturaGasto >= 10 ? 10 : 0)
    ));

    categoryScores.proteccion = Math.min(100, (
      (seguros * 20) + (estatePlanning * 30)
    ));

    categoryScores.control = Math.min(100, control * 33);

    // Stage determination
    let stage = 1;
    
    // Stage 2: Security
    if(cashFlowStatus !== 'no' && reserva >= 3 && dti <= 40 && seguros >= 1) {
      stage = 2;
      stageProgress[1] = 100;
      stageProgress[2] = Math.min(100, (
        (reserva >= 12 ? 30 : reserva >= 9 ? 25 : reserva >= 6 ? 15 : 10) +
        (dti <= 30 ? 30 : dti <= 35 ? 20 : 15) +
        (tasaAhorro >= 15 ? 25 : tasaAhorro >= 10 ? 15 : 10) +
        (patrimonioNeto >= 3 ? 15 : patrimonioNeto >= 1 ? 10 : 5)
      ));
    }
    
    // Stage 3: Accumulation
    if(reserva >= 9 && tasaAhorro >= 15 && patrimonioNeto >= 3 && retiroAcumulado >= 3 && dti <= 30) {
      stage = 3;
      stageProgress[2] = 100;
      stageProgress[3] = Math.min(100, (
        (tasaAhorro >= 30 ? 30 : tasaAhorro >= 25 ? 25 : tasaAhorro >= 20 ? 20 : 15) +
        (patrimonioNeto >= 15 ? 30 : patrimonioNeto >= 10 ? 25 : patrimonioNeto >= 7 ? 20 : 15) +
        (retiroAcumulado >= 10 ? 25 : retiroAcumulado >= 7 ? 20 : retiroAcumulado >= 5 ? 15 : 10) +
        (pasivoCoberturaGasto >= 25 ? 15 : pasivoCoberturaGasto >= 10 ? 10 : 5)
      ));
    }
    
    // Stage 4: Independence
    if(patrimonioNeto >= 10 && pasivoCoberturaGasto >= 50 && estatePlanning >= 2 && dti <= 20) {
      stage = 4;
      stageProgress[3] = 100;
      stageProgress[4] = Math.min(100, (
        (pasivoCoberturaGasto >= 100 ? 50 : pasivoCoberturaGasto >= 75 ? 40 : pasivoCoberturaGasto >= 60 ? 30 : 20) +
        (patrimonioNeto >= 25 ? 30 : patrimonioNeto >= 20 ? 25 : patrimonioNeto >= 15 ? 20 : 15) +
        (dti <= 10 ? 20 : dti <= 15 ? 15 : 10)
      ));
    }
    
    // Stage 5: Freedom
    if(patrimonioNeto >= 30 && pasivoCoberturaGasto >= 120 && estatePlanning >= 3 && dti <= 10) {
      stage = 5;
      stageProgress[4] = 100;
      stageProgress[5] = 100;
    }

    // Calculate progress for stage 1 if still there
    if(stage === 1) {
      stageProgress[1] = Math.min(100, (
        (cashFlowStatus === 'sobra' ? 30 : cashFlowStatus === 'justo' ? 20 : 5) +
        (reserva >= 1 ? 25 : reserva >= 0.5 ? 15 : 5) +
        (dti <= 50 ? 25 : dti <= 60 ? 15 : 5) +
        (control >= 2 ? 20 : control >= 1 ? 10 : 5)
      ));
    }

    userStage = stage;
    userPercent = stageProgress[stage];
  }

  function showResults(){
    document.querySelectorAll('.question').forEach(q => q.style.display = 'none');
    results.classList.add('show');
    
    const s = STAGES[userStage];
    document.getElementById('resultIcon').textContent = s.icon;
    document.getElementById('resultStage').textContent = s.pill;
    document.getElementById('resultPercent').textContent = Math.round(userPercent) + '%';
    
    // Category scores display
    const catScoresHTML = Object.entries(categoryScores).map(([cat, score]) => {
      const labels = {
        flujo: 'Flujo de Caja',
        deuda: 'Deuda',
        ahorro: 'Ahorro/Inversi√≥n',
        pasivo: 'Ingresos Pasivos',
        proteccion: 'Seguros/Protecci√≥n',
        control: 'Control'
      };
      return `
        <div class="catScore">
          <div class="catScoreTitle">${labels[cat]}</div>
          <div class="catScoreBar">
            <div class="catScoreFill" style="width:${score}%"></div>
          </div>
          <div class="catScoreVal">${Math.round(score)}/100</div>
        </div>
      `;
    }).join('');
    document.getElementById('categoryScores').innerHTML = catScoresHTML;
    
    btnNext.textContent = 'Ver mi plan ‚Üí';
    btnNext.onclick = ()=>{
      modal.classList.remove('show');
      renderApp();
    };
    btnBack.style.display = 'none';
    progressBar.style.width = '100%';
  }

  function renderApp(){
    // Update pyramid
    for(let i = 1; i <= 5; i++){
      const el = document.querySelector(`.pstep[data-step="${i}"]`);
      const prog = stageProgress[i] || 0;
      el.querySelector('[data-progress]').style.width = prog + '%';
      el.querySelector('[data-percent]').textContent = Math.round(prog) + '%';
      
      el.classList.remove('active', 'done');
      if(i < userStage) el.classList.add('done');
      if(i === userStage) el.classList.add('active');
    }
    
    document.querySelectorAll('.stageBtn').forEach(btn => {
      btn.classList.toggle('active', +btn.dataset.stage === userStage);
    });
    
    render(userStage);
    updateActionPanel();
  }

  function render(stage){
    const s = STAGES[stage];

    document.getElementById('stagePill').textContent = s.pill;
    document.getElementById('stageTitle').textContent = s.title;
    document.getElementById('stageMini').textContent = s.mini;

    // Criteria
    const criteriaHTML = s.criteria.map(c => `<div class="bigQuote" style="margin-bottom:8px">‚Ä¢ ${c}</div>`).join('');
    document.getElementById('criteria').innerHTML = criteriaHTML;

    // User metrics
    const metricsHTML = `
      <div class="metric">
        <div class="metricTop">
          <div class="metricName">Reserva</div>
          <div class="metricIcon">üí∞</div>
        </div>
        <div class="metricVal">${userMetrics.reserva || 0} meses</div>
        <div class="metricDesc">Gastos esenciales cubiertos</div>
      </div>
      <div class="metric">
        <div class="metricTop">
          <div class="metricName">DTI</div>
          <div class="metricIcon">üí≥</div>
        </div>
        <div class="metricVal">${userMetrics.dti || 0}%</div>
        <div class="metricDesc">Deuda / Ingreso</div>
      </div>
      <div class="metric">
        <div class="metricTop">
          <div class="metricName">Ahorro</div>
          <div class="metricIcon">üìä</div>
        </div>
        <div class="metricVal">${userMetrics.tasaAhorro || 0}%</div>
        <div class="metricDesc">Tasa mensual</div>
      </div>
      <div class="metric">
        <div class="metricTop">
          <div class="metricName">Patrimonio</div>
          <div class="metricIcon">üè¶</div>
        </div>
        <div class="metricVal">${userMetrics.patrimonioNeto}√ó</div>
        <div class="metricDesc">Vs ingreso anual</div>
      </div>
    `;
    document.getElementById('userMetrics').innerHTML = metricsHTML;

    // Requirements
    const reqHTML = s.requirements.map((r, i) => `
      <li>
        <div class="badge">${i+1}</div>
        <div>
          <div class="liTitle">${r.t}</div>
          <div class="liText">${r.d}</div>
        </div>
      </li>
    `).join('');
    document.getElementById('requirements').innerHTML = reqHTML;

    const dot = document.getElementById('stageDot');
    dot.style.background = stage===1 ? "#ef4444" : stage===2 ? "#f59e0b" : stage===3 ? "#e8c239" : stage===4 ? "#3956E8" : "#7459D9";
  }

  function updateActionPanel(){
    // Determine weakest areas
    const sortedCats = Object.entries(categoryScores).sort((a,b) => a[1] - b[1]);
    const weakest = sortedCats.slice(0, 3);
    
    const catLabels = {
      flujo: 'Flujo de caja insuficiente',
      deuda: 'Nivel de deuda muy alto',
      ahorro: 'Bajo ahorro/inversi√≥n',
      pasivo: 'Sin ingresos pasivos',
      proteccion: 'Falta protecci√≥n/seguros',
      control: 'Sin control financiero'
    };

    const weakHTML = weakest.filter(w => w[1] < 60).map(w => `<li>${catLabels[w[0]]}</li>`).join('');
    document.getElementById('weakAreasList').innerHTML = weakHTML || '<li style="color:var(--ok)">‚úì Todas las √°reas en buen nivel</li>';

    // Set goal based on stage
    const goals = {
      1: {
        title: 'Construir reserva de 1 mes',
        current: userMetrics.reserva + ' meses',
        target: 'Meta: 1 mes',
        progress: Math.min(100, (userMetrics.reserva / 1) * 100),
        steps: [
          'Eliminar uso de cr√©dito para gastos b√°sicos',
          'Ahorra $200-300/mes m√≠nimo',
          'Reduce gastos innecesarios 20%',
          'Establece presupuesto mensual simple'
        ]
      },
      2: {
        title: 'Elevar reserva a 9 meses',
        current: userMetrics.reserva + ' meses',
        target: 'Meta: 9 meses',
        progress: Math.min(100, (userMetrics.reserva / 9) * 100),
        steps: [
          'Ahorra 15-20% de ingresos',
          'Reduce DTI a menos del 30%',
          'Obt√©n seguros de vida + discapacidad',
          'Mant√©n tracking financiero mensual'
        ]
      },
      3: {
        title: 'Patrimonio 15√ó ingreso anual',
        current: userMetrics.patrimonioNeto + '√ó ingreso',
        target: 'Meta: 15√ó ingreso',
        progress: Math.min(100, (userMetrics.patrimonioNeto / 15) * 100),
        steps: [
          'Incrementa ahorro a 25-30%',
          'Diversifica inversiones',
          'Aumenta contribuciones al retiro',
          'Genera primeros ingresos pasivos'
        ]
      },
      4: {
        title: 'Ingresos pasivos = 100% gastos',
        current: userMetrics.pasivoCoberturaGasto + '% cobertura',
        target: 'Meta: 100% cobertura',
        progress: Math.min(100, userMetrics.pasivoCoberturaGasto),
        steps: [
          'Optimiza portafolio de inversiones',
          'Incrementa flujos de ingreso pasivo',
          'Establece estate planning completo',
          'Reduce DTI a menos del 10%'
        ]
      },
      5: {
        title: 'Mantener y proteger legado',
        current: 'Etapa m√°xima',
        target: 'Optimizaci√≥n continua',
        progress: 100,
        steps: [
          'Optimizaci√≥n fiscal avanzada',
          'Estructuras de protecci√≥n patrimonial',
          'Planificaci√≥n multigeneracional',
          'Filantrop√≠a estrat√©gica'
        ]
      }
    };

    const g = goals[userStage];
    document.getElementById('nextGoalTitle').textContent = g.title;
    document.getElementById('nextGoalCurrent').textContent = g.current;
    document.getElementById('nextGoalTarget').textContent = g.target;
    document.getElementById('nextGoalProgress').style.width = g.progress + '%';
    document.getElementById('actionSteps').innerHTML = g.steps.map(s => `<li>${s}</li>`).join('');
  }

  function retakeQuiz(){
    currentQ = 1;
    answers = {};
    document.querySelectorAll('.qInput').forEach(input => input.value = '');
    document.querySelectorAll('.optBtn, .optBtnGrid').forEach(btn => btn.classList.remove('selected'));
    
    modal.classList.add('show');
    results.classList.remove('show');
    document.querySelectorAll('.question').forEach(q => q.style.display = 'block');
    showQuestion(1);
    btnNext.textContent = 'Siguiente ‚Üí';
    btnNext.onclick = null;
  }

  // Stage buttons
  const stageBtns = document.querySelectorAll('.stageBtn');
  stageBtns.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      stageBtns.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      render(+btn.dataset.stage);
    });
  });

  document.querySelectorAll('.pstep').forEach(el=>{
    el.addEventListener('click', ()=>{
      const stage = +el.getAttribute('data-step');
      stageBtns.forEach(b=>b.classList.toggle('active', +b.dataset.stage === stage));
      render(stage);
    });
  });

  showQuestion(1);
</script>
</body>
</html>
